<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>UK Mart — Grocery Marketplace</title>

  <!-- jsPDF for Invoice PDF -->
  <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

  <!-- Leaflet (Real Map) -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    :root{
      --bg:#f5f7fb; --card:#fff; --text:#0f172a; --muted:#64748b;
      --brand:#2563eb; --brand2:#22c55e; --line:#e5e7eb;
      --good:#16a34a; --warn:#f59e0b; --bad:#dc2626;
      --shadow:0 14px 40px rgba(2,6,23,.10); --radius:18px;
      --blueSoft: rgba(37,99,235,.10);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text)}
    a{color:inherit;text-decoration:none}
    button{font-family:inherit}
    .container{max-width:1200px;margin:0 auto;padding:14px}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:20;background:linear-gradient(90deg,var(--brand),#38bdf8);color:#fff;border-bottom:1px solid rgba(255,255,255,.18)}
    .topbarInner{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px 14px;max-width:1200px;margin:0 auto}
    .brand{display:flex;align-items:center;gap:10px;min-width:220px}
    .logo{width:42px;height:42px;border-radius:14px;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.25);display:grid;place-items:center;font-weight:900;letter-spacing:.5px}
    .brandText .name{font-weight:900;font-size:16px;line-height:1}
    .brandText .tag{font-size:12px;opacity:.92}

    .searchWrap{flex:1;display:flex;gap:10px;align-items:center;max-width:560px}
    .search{flex:1;display:flex;background:rgba(255,255,255,.95);border-radius:14px;overflow:hidden;border:1px solid rgba(255,255,255,.25)}
    .search input{flex:1;border:none;outline:none;padding:10px 12px;font-size:14px;background:transparent}
    .search button{border:none;cursor:pointer;padding:10px 12px;font-weight:900;background:#0f172a;color:#fff}
    .actions{display:flex;gap:10px;align-items:center}
    .iconBtn{border:none;cursor:pointer;background:rgba(255,255,255,.16);color:#fff;border:1px solid rgba(255,255,255,.22);padding:10px 12px;border-radius:14px;font-size:18px}
    .pillMini{display:flex;gap:8px;align-items:center;background:rgba(255,255,255,.16);border:1px solid rgba(255,255,255,.22);padding:8px 10px;border-radius:999px;font-size:12px;white-space:nowrap}
    .pillMini b{font-size:13px}

    /* Drawer */
    .drawerBackdrop{position:fixed;inset:0;background:rgba(2,6,23,.45);display:none;z-index:40}
    .drawer{position:fixed;top:0;right:0;height:100%;width:min(390px,92vw);background:#fff;box-shadow:-18px 0 50px rgba(0,0,0,.22);transform:translateX(100%);transition:transform .25s ease;z-index:50;display:flex;flex-direction:column}
    .drawer.open{transform:translateX(0)}
    .drawerBackdrop.show{display:block}
    .drawerHead{padding:14px;border-bottom:1px solid var(--line);display:flex;justify-content:space-between;align-items:center}
    .drawerHead .title{font-weight:1000}
    .drawerHead button{border:none;background:#f1f5f9;cursor:pointer;padding:10px 12px;border-radius:12px;font-weight:1000}
    .drawerBody{padding:12px;overflow:auto}
    .drawerBody .navBtn{
      width:100%;display:flex;justify-content:space-between;align-items:center;
      padding:12px;border-radius:14px;border:1px solid var(--line);
      background:#fff;cursor:pointer;font-weight:900;margin-bottom:10px;
      transition:box-shadow .12s ease, border-color .12s ease, background .12s ease, color .12s ease;
    }
    .drawerBody .navBtn:hover{border-color:#cbd5e1}
    .drawerBody .navBtn.active{
      border-color:#93c5fd;
      background:var(--blueSoft);
      box-shadow:0 0 0 4px rgba(59,130,246,.12);
      color:#0b2b7a;
    }
    .drawerBody .sub{margin:12px 0 6px;color:var(--muted);font-weight:1000;font-size:12px;letter-spacing:.4px;text-transform:uppercase}

    /* Hero */
    .banner{background:linear-gradient(90deg,#fff,#eef2ff);border:1px solid var(--line);border-radius:var(--radius);padding:14px;box-shadow:var(--shadow);display:flex;gap:14px;justify-content:space-between;align-items:center;flex-wrap:wrap}
    .banner h1{margin:0;font-size:22px}
    .banner p{margin:6px 0 0;color:var(--muted)}
    .cta{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .btn{border:none;cursor:pointer;padding:10px 12px;border-radius:14px;font-weight:1000;background:#fff;border:1px solid var(--line)}
    .btn.primary{background:#0f172a;color:#fff;border-color:#0f172a}
    .btn.green{background:var(--brand2);color:#062e12;border-color:transparent}
    .btn.ghost{background:transparent;border-color:rgba(255,255,255,.25);color:#fff}
    .btn:disabled{opacity:.55;cursor:not-allowed}

    /* Category quick bar */
    .catBar{
      margin-top:12px;background:#fff;border:1px solid var(--line);border-radius:18px;
      box-shadow:var(--shadow);padding:10px;display:flex;gap:10px;align-items:center;flex-wrap:wrap;
    }
    .catBar .chip{
      padding:10px 12px;border-radius:999px;border:1px solid var(--line);
      background:#fff;cursor:pointer;font-weight:1000;font-size:13px;
    }
    .catBar .chip.active{border-color:#93c5fd; box-shadow:0 0 0 4px rgba(59,130,246,.12)}
    .catBar .right{margin-left:auto;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .select{
      padding:10px 12px;border-radius:14px;border:1px solid var(--line);
      background:#fff;font-weight:900;
    }

    /* Layout */
    .grid{display:grid;grid-template-columns:1.65fr .55fr;gap:14px;align-items:start;margin-top:14px}
    .section{background:var(--card);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow);overflow:hidden}
    .sectionHead{padding:12px 14px;display:flex;justify-content:space-between;align-items:center;gap:10px;border-bottom:1px solid var(--line);background:linear-gradient(90deg,#fff,#f8fafc)}
    .sectionHead h2{margin:0;font-size:16px}
    .muted{color:var(--muted)}
    .tiny{font-size:12px;color:var(--muted);font-weight:900}

    /* Product horizontal slider */
    .rowWrap{padding:12px 14px}
    .hRow{
      display:flex; gap:12px; overflow-x:auto; padding-bottom:8px;
      scroll-snap-type:x mandatory; -webkit-overflow-scrolling:touch;
    }
    .hRow::-webkit-scrollbar{height:10px}
    .hRow::-webkit-scrollbar-thumb{background:#dbeafe;border-radius:999px}
    .hRow::-webkit-scrollbar-track{background:#f1f5f9;border-radius:999px}

    .pCard{
      min-width:220px; max-width:220px;
      background:#fff;border:1px solid var(--line);border-radius:16px;
      overflow:hidden; scroll-snap-align:start;
      transition:transform .12s ease, box-shadow .12s ease;
    }
    .pCard:hover{transform:translateY(-2px); box-shadow:0 18px 50px rgba(2,6,23,.10)}
    .pImg{width:100%;height:120px;object-fit:cover;background:#e5e7eb}
    .pad{padding:10px}
    .row{display:flex;justify-content:space-between;align-items:flex-start;gap:10px}
    .name{font-weight:1000}
    .cat{font-size:12px;color:var(--muted);margin-top:2px}
    .price{font-weight:1000;font-size:16px}
    .tag{display:inline-block;padding:6px 10px;border-radius:999px;font-weight:1000;font-size:12px;white-space:nowrap}
    .tag.good{background:#dcfce7;color:#166534}
    .tag.warn{background:#fef3c7;color:#92400e}
    .tag.bad{background:#fee2e2;color:#991b1b}
    .qty{display:flex;align-items:center;gap:8px}
    .qty button{
      width:34px;height:34px;border-radius:12px;border:1px solid var(--line);
      background:#fff;cursor:pointer;font-weight:1000;font-size:16px;
    }
    .qty .num{min-width:18px;text-align:center;font-weight:1000}

    /* Basket */
    .basket{position:sticky;top:78px}
    .basketBody{padding:12px 14px}
    .basketItem{display:flex;gap:10px;align-items:center;border:1px solid var(--line);border-radius:14px;padding:10px;margin-bottom:10px;background:#fff}
    .basketItem img{width:56px;height:56px;border-radius:12px;object-fit:cover;background:#e5e7eb}
    .basketItem .info{flex:1}
    .basketItem .info .t{font-weight:1000;font-size:13px}
    .basketItem .info .s{color:var(--muted);font-size:12px}
    .basketTotals{border-top:1px dashed var(--line);padding-top:10px;margin-top:10px}
    .kv{display:flex;justify-content:space-between;margin:6px 0;font-weight:900}
    .kv .k{color:var(--muted);font-weight:1000}
    .payNote{color:var(--muted);font-size:12px;margin-top:10px}

    /* Modals */
    .modalBackdrop{position:fixed;inset:0;background:rgba(2,6,23,.55);display:none;z-index:60;padding:16px}
    .modal{max-width:1000px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 30px 90px rgba(0,0,0,.35);overflow:hidden}
    .modalHead{padding:12px 14px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--line);background:linear-gradient(90deg,#fff,#f8fafc)}
    .modalHead .title{font-weight:1100}
    .modalHead button{border:none;cursor:pointer;background:#f1f5f9;padding:10px 12px;border-radius:12px;font-weight:1100}
    .modalBody{padding:14px}
    .twoCol{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    .field label{display:block;font-weight:1000;font-size:12px;color:var(--muted);margin:4px 0}
    .field input,.field select,.field textarea{width:100%;padding:10px 12px;border-radius:14px;border:1px solid var(--line);outline:none;background:#fff}
    .note{margin-top:10px;color:var(--muted);font-weight:900;font-size:13px}
    .hr{height:1px;background:var(--line);margin:12px 0}
    .tableWrap{overflow:auto;border:1px solid var(--line);border-radius:16px}
    table{width:100%;border-collapse:collapse;background:#fff}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:13px}
    th{background:#f8fafc;font-weight:1100}

    /* See-all grid in modal */
    .gridCards{
      display:grid; grid-template-columns:repeat(4, minmax(0,1fr));
      gap:12px; margin-top:10px;
    }
    .gridCards .pCard{min-width:auto;max-width:none}

    /* Accordion (Help/Support/Settings inside modal) */
    .acc{border:1px solid var(--line);border-radius:16px;overflow:hidden;background:#fff}
    .accBtn{
      width:100%;text-align:left;
      display:flex;justify-content:space-between;align-items:center;
      padding:12px 12px;border:none;background:#fff;cursor:pointer;font-weight:1100;
      border-bottom:1px solid var(--line);
      transition:background .12s ease, color .12s ease;
    }
    .accBtn:last-child{border-bottom:none}
    .accBtn.active{background:var(--blueSoft);color:#0b2b7a}
    .accPanel{display:none;padding:12px 12px;background:#fff}
    .accPanel.show{display:block}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:999px;border:1px solid var(--line);font-weight:1000;font-size:12px;background:#fff}

    /* Maps */
    .mapBox{height:360px;border-radius:18px;border:1px solid var(--line);overflow:hidden}
    .mapGrid{display:grid;grid-template-columns:1.2fr .8fr;gap:12px}
    .statusCard{border:1px solid var(--line);border-radius:18px;padding:12px;background:#fff}
    .statusCard h3{margin:0 0 8px;font-size:14px}
    .statusRow{display:flex;justify-content:space-between;gap:10px;margin:8px 0;font-weight:1000}
    .statusRow .k{color:var(--muted);font-weight:1100}

    @media (max-width:980px){
      .grid{grid-template-columns:1fr}
      .basket{position:relative;top:0}
      .gridCards{grid-template-columns:repeat(2,minmax(0,1fr))}
      .mapGrid{grid-template-columns:1fr}
    }
    @media (max-width:520px){
      .searchWrap{display:none}
      .gridCards{grid-template-columns:1fr}
      .pCard{min-width:210px;max-width:210px}
    }
  </style>
</head>

<body>
  <!-- TOPBAR -->
  <div class="topbar">
    <div class="topbarInner">
      <a class="brand" href="#" onclick="return false;">
        <div class="logo">UK</div>
        <div class="brandText">
          <div class="name">UK Mart</div>
          <div class="tag">Grocery Marketplace • Smart Pricing</div>
        </div>
      </a>

      <div class="searchWrap">
        <div class="search">
          <input id="q" placeholder="Search rice, oil, atta, soap..." />
          <button onclick="App.search()">Search</button>
        </div>
      </div>

      <div class="actions">
        <div class="pillMini"><span>Market</span><b id="marketIndex">—</b></div>
        <button class="iconBtn" onclick="UI.openDrawer()">⋮</button>
      </div>
    </div>
  </div>

  <!-- DRAWER -->
  <div id="drawerBackdrop" class="drawerBackdrop" onclick="UI.closeDrawer()"></div>
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="drawerHead">
      <div class="title">Menu</div>
      <button onclick="UI.closeDrawer()">Close</button>
    </div>
    <div class="drawerBody">
      <button class="navBtn" data-nav="home" onclick="Nav.go('home')"><span>Home</span><span>→</span></button>
      <button class="navBtn" data-nav="products" onclick="Nav.go('products')"><span>Products</span><span>→</span></button>
      <button class="navBtn" data-nav="basket" onclick="Nav.go('basket')"><span>Basket</span><span>→</span></button>

      <div class="sub">Tracking</div>
      <button class="navBtn" data-nav="track" onclick="Nav.go('track')"><span>Live Tracking (Map)</span><span>→</span></button>
      <button class="navBtn" data-nav="driver" onclick="Nav.go('driver')"><span>Driver Panel</span><span>→</span></button>

      <div class="sub">Account</div>
      <button class="navBtn" data-nav="account" onclick="Nav.go('account')"><span>Login / Register</span><span>→</span></button>

      <div class="sub">Seller</div>
      <button class="navBtn" data-nav="seller" onclick="Nav.go('seller')"><span>Vendor Panel</span><span>→</span></button>

      <div class="sub">Admin</div>
      <button class="navBtn" data-nav="admin" onclick="Nav.go('admin')"><span>Commission Dashboard</span><span>→</span></button>

      <div class="sub">Help & Support</div>
      <button class="navBtn" data-nav="help" onclick="Nav.go('help')"><span>Help Center</span><span>→</span></button>

      <div class="sub">Settings</div>
      <button class="navBtn" data-nav="settings" onclick="Nav.go('settings')"><span>Language & Area</span><span>→</span></button>
    </div>
  </aside>

  <main class="container" id="top">
    <!-- HERO -->
    <section class="banner">
      <div>
        <h1>UK Mart — Quick grocery shopping</h1>
        <p>Compact sections + horizontal sliders. Add to basket, place order, and download PDF bill.</p>
        <p class="tiny" style="margin-top:10px">
          Area: <b id="areaLabel">Not set</b> • Tip: Use search to filter products instantly.
        </p>
      </div>
      <div class="cta">
        <button class="btn primary" onclick="Nav.go('products')">Browse Products</button>
        <button class="btn" onclick="Nav.go('track')">Live Tracking</button>
        <button class="btn" onclick="Nav.go('settings')">Settings</button>
      </div>
    </section>

    <!-- QUICK CATEGORY BAR -->
    <section class="catBar" id="products">
      <div id="catChips"></div>
      <div class="right">
        <select class="select" id="stockFilter" onchange="App.render()" title="Stock filter">
          <option value="all">All</option>
          <option value="available">Available</option>
          <option value="out">Out of stock</option>
          <option value="unavailable">Unavailable</option>
        </select>
        <button class="btn" onclick="App.reset()">Reset</button>
      </div>
    </section>

    <div class="grid">
      <!-- LEFT: PRODUCT SECTIONS -->
      <div id="sections"></div>

      <!-- RIGHT: BASKET -->
      <aside class="section basket" id="basket">
        <div class="sectionHead">
          <h2>Basket</h2>
          <button class="btn" onclick="Cart.clear()">Clear</button>
        </div>
        <div class="basketBody">
          <div id="basketItems"></div>

          <div class="basketTotals">
            <div class="kv"><div class="k">Subtotal</div><div id="subTotal">₹0</div></div>
            <div class="kv"><div class="k">Tax/Handling</div><div id="taxTotal">₹0</div></div>
            <div class="kv"><div class="k">Grand total</div><div id="grandTotal">₹0</div></div>

            <div class="payNote">
              Place order to download a PDF invoice. Live tracking works via Driver Panel.
            </div>

            <button class="btn primary" style="width:100%;margin-top:10px" onclick="Orders.placeFromCart()">
              Place Order & Download Bill (PDF)
            </button>
          </div>
        </div>
      </aside>
    </div>

    <div class="muted" style="padding:14px;text-align:center">
      © <span id="year"></span> UK Mart • Single-page (GitHub Pages friendly)
    </div>
  </main>

  <!-- MODALS -->
  <div id="modalBackdrop" class="modalBackdrop" onclick="Modal.backdropClose(event)">

    <!-- LIVE TRACKING (CUSTOMER) -->
    <div class="modal" id="modal-track" style="display:none" onclick="event.stopPropagation()">
      <div class="modalHead"><div class="title">Live Tracking — Customer</div><button onclick="Modal.close()">Close</button></div>
      <div class="modalBody">
        <div class="note">
          Real map (OpenStreetMap). Driver location updates live (best on HTTPS). For demo: open Driver Panel in another tab and start live share.
        </div>

        <div class="hr"></div>

        <div class="mapGrid">
          <div class="mapBox" id="customerMap"></div>

          <div class="statusCard">
            <h3>Delivery Status</h3>

            <div class="statusRow"><div class="k">Pickup (UK Mart)</div><div id="pickupLabel">—</div></div>
            <div class="statusRow"><div class="k">Delivery</div><div id="dropLabel">—</div></div>
            <div class="statusRow"><div class="k">Driver</div><div id="driverLabel">—</div></div>
            <div class="statusRow"><div class="k">Driver phone</div><div id="driverPhoneLabel">—</div></div>
            <div class="statusRow"><div class="k">ETA</div><div id="etaLabel">—</div></div>

            <div class="hr"></div>

            <div class="field">
              <label>Delivery address (optional)</label>
              <textarea id="custAddress" rows="3" placeholder="Type your address…"></textarea>
            </div>

            <div class="twoCol" style="margin-top:10px;grid-template-columns:1fr 1fr">
              <div class="field">
                <label>Delivery lat</label>
                <input id="dropLat" placeholder="e.g., 23.12345">
              </div>
              <div class="field">
                <label>Delivery lng</label>
                <input id="dropLng" placeholder="e.g., 85.12345">
              </div>
            </div>

            <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
              <button class="btn primary" onclick="Tracking.setDropFromInputs()">Set Delivery Point</button>
              <button class="btn" onclick="Tracking.useMyLocationAsDrop()">Use my location</button>
              <button class="btn" onclick="Tracking.resetDemoRoute()">Reset demo route</button>
            </div>

            <div class="note" id="custTrackMsg"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- DRIVER PANEL -->
    <div class="modal" id="modal-driver" style="display:none" onclick="event.stopPropagation()">
      <div class="modalHead"><div class="title">Driver Panel</div><button onclick="Modal.close()">Close</button></div>
      <div class="modalBody">
        <div class="note">
          Driver GPS share: click “Start Live Share” (allow location). Customer will see you moving on map.
        </div>

        <div class="hr"></div>

        <div class="mapGrid">
          <div class="mapBox" id="driverMap"></div>

          <div class="statusCard">
            <h3>Driver Controls</h3>

            <div class="field">
              <label>Driver name</label>
              <input id="driverName" placeholder="e.g., Raju">
            </div>
            <div class="field">
              <label>Driver phone</label>
              <input id="driverPhone" placeholder="e.g., +91-9XXXXXXXXX">
            </div>

            <div class="twoCol" style="grid-template-columns:1fr 1fr;margin-top:10px">
              <button class="btn primary" onclick="Driver.start()">Start Live Share</button>
              <button class="btn" onclick="Driver.stop()">Stop</button>
            </div>

            <div class="hr"></div>

            <div class="statusRow"><div class="k">Status</div><div id="driverStatus">Not sharing</div></div>
            <div class="statusRow"><div class="k">Last location</div><div id="driverLast">—</div></div>
            <div class="statusRow"><div class="k">Tip</div><div class="pill">Use HTTPS for best GPS</div></div>

            <div class="hr"></div>

            <div style="display:flex;gap:10px;flex-wrap:wrap">
              <button class="btn" onclick="Driver.mark('picked_up')">Mark Picked Up</button>
              <button class="btn green" onclick="Driver.mark('delivered')">Mark Delivered</button>
            </div>

            <div class="note" id="driverMsg"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ACCOUNT -->
    <div class="modal" id="modal-account" style="display:none" onclick="event.stopPropagation()">
      <div class="modalHead"><div class="title">Account</div><button onclick="Modal.close()">Close</button></div>
      <div class="modalBody">
        <div class="twoCol">
          <div>
            <h3 style="margin:0 0 8px">Login</h3>
            <div class="field"><label>Phone/Email</label><input id="loginId" placeholder="example@gmail.com"/></div>
            <div class="field"><label>Password</label><input id="loginPass" type="password" placeholder="••••••••"/></div>
            <button class="btn primary" onclick="Account.login()" style="margin-top:10px">Login</button>
            <button class="btn" onclick="Account.logout()" style="margin-top:10px">Logout</button>
            <div class="note" id="accountStatus"></div>
          </div>

          <div>
            <h3 style="margin:0 0 8px">Register</h3>
            <div class="field"><label>Name</label><input id="regName" placeholder="Your name"/></div>
            <div class="field"><label>Phone/Email</label><input id="regId" placeholder="example@gmail.com"/></div>
            <div class="field"><label>Password</label><input id="regPass" type="password" placeholder="Create password"/></div>
            <div class="field">
              <label>Role</label>
              <select id="regRole">
                <option value="customer">Customer</option>
                <option value="seller">Seller/Vendor</option>
                <option value="driver">Driver</option>
              </select>
            </div>
            <button class="btn primary" onclick="Account.register()" style="margin-top:10px">Create account</button>
            <div class="note">Vendor can add products. Driver can share live location.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- SELLER -->
    <div class="modal" id="modal-seller" style="display:none" onclick="event.stopPropagation()">
      <div class="modalHead"><div class="title">Vendor Panel</div><button onclick="Modal.close()">Close</button></div>
      <div class="modalBody">
        <div class="note">
          Login as Vendor to add products. Your products will appear in the main list instantly.
          Vendor site charge is hidden from customers and applies after 90 days (profit-based demo).
        </div>
        <div class="hr"></div>

        <div class="twoCol">
          <div>
            <div class="field"><label>Product name</label><input id="spName" placeholder="e.g., Toor Dal 1kg"/></div>
            <div class="field"><label>Category</label><select id="spCat"></select></div>
            <div class="field"><label>Base price (₹)</label><input id="spPrice" type="number" placeholder="e.g., 140"/></div>
            <div class="field">
              <label>Status</label>
              <select id="spStatus">
                <option value="available">Available</option>
                <option value="out">Out of stock</option>
                <option value="unavailable">Unavailable</option>
              </select>
            </div>
            <div class="field"><label>Image URL (optional)</label><input id="spImg" placeholder="https://..."/></div>
            <button class="btn primary" onclick="Seller.add()" style="margin-top:10px">Save product</button>
            <button class="btn" onclick="Seller.clearMine()" style="margin-top:10px">Clear my products</button>
            <div class="note" id="sellerMsg"></div>
          </div>

          <div>
            <div class="tableWrap">
              <table>
                <thead><tr><th>My products</th><th>Status</th><th>Base</th></tr></thead>
                <tbody id="sellerTable"></tbody>
              </table>
            </div>

            <div class="hr"></div>
            <div class="note" style="font-weight:1100">Vendor fee (hidden)</div>
            <div class="note" id="vendorFeeBox"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- ADMIN -->
    <div class="modal" id="modal-admin" style="display:none" onclick="event.stopPropagation()">
      <div class="modalHead"><div class="title">Admin — Commission Dashboard</div><button onclick="Modal.close()">Close</button></div>
      <div class="modalBody">
        <div class="note">Commission auto-calculates from market index (demo). You can override manually.</div>

        <div class="twoCol" style="margin-top:10px">
          <div>
            <div class="field">
              <label>Commission mode</label>
              <select id="commissionMode" onchange="Admin.applyMode()">
                <option value="auto">Auto (market-based)</option>
                <option value="manual">Manual override</option>
              </select>
            </div>
            <div class="field">
              <label>Commission %</label>
              <input id="commissionPct" type="number" min="0" max="50" step="0.5"/>
            </div>
            <button class="btn primary" onclick="Admin.save()">Save</button>
            <button class="btn" onclick="Admin.clearOrders()" style="margin-top:10px">Clear orders (demo)</button>

            <div class="hr"></div>
            <div class="kv"><div class="k">Total orders</div><div id="admOrders">0</div></div>
            <div class="kv"><div class="k">Sales amount</div><div id="admSales">₹0</div></div>
            <div class="kv"><div class="k">Commission earned</div><div id="admComm">₹0</div></div>
          </div>

          <div>
            <div class="tableWrap">
              <table>
                <thead><tr><th>Time</th><th>Product</th><th>Qty</th><th>Total</th><th>Commission</th></tr></thead>
                <tbody id="ordersTable"></tbody>
              </table>
            </div>
            <div class="note">Orders are stored in browser (localStorage). Works on GitHub Pages.</div>
          </div>
        </div>
      </div>
    </div>

    <!-- HELP -->
    <div class="modal" id="modal-help" style="display:none" onclick="event.stopPropagation()">
      <div class="modalHead"><div class="title">Help & Support</div><button onclick="Modal.close()">Close</button></div>
      <div class="modalBody">
        <div class="acc" id="helpAcc">
          <button class="accBtn" data-acc="acc1" onclick="Accordion.toggle('helpAcc','acc1')">
            Create account <span>▾</span>
          </button>
          <div class="accPanel" data-panel="acc1">
            <div class="note" style="font-size:14px;line-height:1.6">
              Menu → <b>Login / Register</b> → Fill details → Choose role → Create account.
            </div>
          </div>

          <button class="accBtn" data-acc="acc2" onclick="Accordion.toggle('helpAcc','acc2')">
            Add products (Vendor) <span>▾</span>
          </button>
          <div class="accPanel" data-panel="acc2">
            <div class="note" style="font-size:14px;line-height:1.6">
              Login as Vendor → Menu → <b>Vendor Panel</b> → Add product → Save.
            </div>
          </div>

          <button class="accBtn" data-acc="acc3" onclick="Accordion.toggle('helpAcc','acc3')">
            Live Tracking (Map) <span>▾</span>
          </button>
          <div class="accPanel" data-panel="acc3">
            <div class="note" style="font-size:14px;line-height:1.6">
              Customer: Menu → <b>Live Tracking</b><br/>
              Driver: Menu → <b>Driver Panel</b> → Start Live Share (Allow GPS)<br/>
              Customer map will show pickup → driver → delivery route + ETA.
            </div>
          </div>

          <button class="accBtn" data-acc="acc4" onclick="Accordion.toggle('helpAcc','acc4')">
            Customer Support <span>▾</span>
          </button>
          <div class="accPanel" data-panel="acc4">
            <div class="note" style="font-size:14px;line-height:1.6">
              <b>Phone:</b> +91-90000-00000<br/>
              <b>Email:</b> support@ukmart.example<br/>
              <b>Hours:</b> 9:00 AM – 8:00 PM
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SETTINGS -->
    <div class="modal" id="modal-settings" style="display:none" onclick="event.stopPropagation()">
      <div class="modalHead"><div class="title">Settings</div><button onclick="Modal.close()">Close</button></div>
      <div class="modalBody">
        <div class="acc" id="setAcc">
          <button class="accBtn" data-acc="s1" onclick="Accordion.toggle('setAcc','s1')">
            Language <span>▾</span>
          </button>
          <div class="accPanel" data-panel="s1">
            <div class="field">
              <label>Language (optional)</label>
              <select id="langSelect" onchange="Settings.setLang(this.value)">
                <option value="en">English</option>
                <option value="hi">Hindi</option>
                <option value="bn">Bengali</option>
                <option value="ta">Tamil</option>
                <option value="te">Telugu</option>
                <option value="mr">Marathi</option>
                <option value="gu">Gujarati</option>
                <option value="kn">Kannada</option>
                <option value="ml">Malayalam</option>
                <option value="pa">Punjabi</option>
              </select>
            </div>
            <div class="note">UI stays English in this free single-file version (language saved for future backend).</div>
          </div>

          <button class="accBtn" data-acc="s2" onclick="Accordion.toggle('setAcc','s2')">
            Delivery Area <span>▾</span>
          </button>
          <div class="accPanel" data-panel="s2">
            <div class="field">
              <label>Delivery area</label>
              <select id="areaSelect" onchange="Settings.setArea(this.value)">
                <option value="">Not set</option>
                <option value="Jharsuguda">Jharsuguda</option>
                <option value="Brajrajnagar">Brajrajnagar</option>
                <option value="Dumka">Dumka</option>
                <option value="Madhupur">Madhupur</option>
              </select>
            </div>
            <div class="note">Area is shown on home + invoice.</div>
          </div>

          <button class="accBtn" data-acc="s3" onclick="Accordion.toggle('setAcc','s3')">
            Privacy & GPS <span>▾</span>
          </button>
          <div class="accPanel" data-panel="s3">
            <div class="note" style="font-size:14px;line-height:1.6">
              For best GPS tracking, host on <b>HTTPS</b>. Browsers may block location on HTTP.
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- SEE ALL PRODUCTS MODAL -->
    <div class="modal" id="modal-seeall" style="display:none" onclick="event.stopPropagation()">
      <div class="modalHead">
        <div class="title" id="seeAllTitle">All products</div>
        <button onclick="Modal.close()">Close</button>
      </div>
      <div class="modalBody">
        <div class="tiny" id="seeAllHint"></div>
        <div class="gridCards" id="seeAllGrid"></div>
      </div>
    </div>
  </div>

<script>
/* ========= Storage ========= */
const LS = {
  get(k, d){ try{ const v = JSON.parse(localStorage.getItem(k)); return (v===null||v===undefined)?d:v; }catch(e){ return d; } },
  set(k, v){ localStorage.setItem(k, JSON.stringify(v)); },
  del(k){ localStorage.removeItem(k); }
};

/* ========= UI / Modal ========= */
const UI = {
  openDrawer(){ document.getElementById("drawer").classList.add("open"); document.getElementById("drawerBackdrop").classList.add("show"); },
  closeDrawer(){ document.getElementById("drawer").classList.remove("open"); document.getElementById("drawerBackdrop").classList.remove("show"); },
  scrollTo(id){ const el=document.getElementById(id); if(el) el.scrollIntoView({behavior:"smooth", block:"start"}); }
};

const Nav = {
  setActive(key){
    document.querySelectorAll(".navBtn").forEach(b=>b.classList.remove("active"));
    const btn = document.querySelector(`.navBtn[data-nav="${key}"]`);
    if(btn) btn.classList.add("active");
  },
  go(key){
    Nav.setActive(key);
    if(key==="home"){ UI.scrollTo("top"); UI.closeDrawer(); return; }
    if(key==="products"){ UI.scrollTo("products"); UI.closeDrawer(); return; }
    if(key==="basket"){ UI.scrollTo("basket"); UI.closeDrawer(); return; }

    // Modals
    Modal.open(key);
    UI.closeDrawer();
  }
};

const Modal = {
  open(which){
    document.getElementById("modalBackdrop").style.display="block";
    ["account","seller","admin","help","settings","seeall","track","driver"].forEach(x=>{
      const m = document.getElementById("modal-"+x);
      if(m) m.style.display = (x===which) ? "block" : "none";
    });

    Nav.setActive(which);

    if(which==="account") Account.refresh();
    if(which==="seller") Seller.refresh();
    if(which==="admin") Admin.refresh();
    if(which==="settings") Settings.refresh();
    if(which==="track") Tracking.openCustomer();
    if(which==="driver") Driver.open();

    // default open first accordion panel for help/settings
    if(which==="help") Accordion.openFirst("helpAcc");
    if(which==="settings") Accordion.openFirst("setAcc");
  },
  close(){
    document.getElementById("modalBackdrop").style.display="none";
    // keep current highlight as-is, or reset to home
  },
  backdropClose(e){ if(e.target.id==="modalBackdrop") Modal.close(); }
};

/* ========= Accordion ========= */
const Accordion = {
  toggle(containerId, panelKey){
    const root = document.getElementById(containerId);
    if(!root) return;
    const buttons = root.querySelectorAll(".accBtn");
    const panels = root.querySelectorAll(".accPanel");
    buttons.forEach(b=>{
      const on = (b.getAttribute("data-acc")===panelKey);
      b.classList.toggle("active", on);
    });
    panels.forEach(p=>{
      const on = (p.getAttribute("data-panel")===panelKey);
      p.classList.toggle("show", on);
    });
  },
  openFirst(containerId){
    const root = document.getElementById(containerId);
    if(!root) return;
    const firstBtn = root.querySelector(".accBtn");
    if(firstBtn){
      const key = firstBtn.getAttribute("data-acc");
      Accordion.toggle(containerId, key);
    }
  }
};

/* ========= Market pricing (demo) ========= */
const Market = {
  index(){
    const d=new Date();
    const seed=d.getFullYear()*10000+(d.getMonth()+1)*100+d.getDate();
    const x=Math.sin(seed)*10000;
    const frac=x-Math.floor(x);
    return 0.92+frac*0.26; // 0.92–1.18
  },
  price(base, cat){
    const idx=Market.index();
    const w=({
      "Edible Oil & Ghee":1.08,
      "Spices & Masala":1.06,
      "Pulses & Beans":1.05,
      "Rice & Grains":1.03,
      "Atta & Flour":1.02
    }[cat]||1.00);
    return Math.max(1, Math.round(base*idx*w));
  },
  autoCommissionPct(){
    const idx=Market.index();
    const normalized=(idx-0.92)/0.26;
    const pct=2.5 + normalized*5.0; // 2.5–7.5
    return Math.round(pct*10)/10;
  }
};

/* ========= Vendor fee hidden (demo) ========= */
const VendorFee = {
  initTrialForSeller(sellerId){
    const key="sellerTrialStart:"+sellerId;
    let start=LS.get(key,null);
    if(!start){ start=Date.now(); LS.set(key,start); }
    return start;
  },
  daysSince(start){ return Math.floor((Date.now()-start)/(1000*60*60*24)); },
  feeDue(profit, days){
    if(days<90) return 0;
    const fee=Math.round(profit*0.02);
    return Math.max(199, fee);
  }
};

/* ========= Catalog ========= */
const Catalog = {
  storeId:"UKMART_STORE",
  categories:[
    "Top Deals",
    "Atta & Flour","Rice & Grains","Pulses & Beans",
    "Edible Oil & Ghee","Spices & Masala",
    "Sugar, Salt & Jaggery","Tea, Coffee & Beverages",
    "Biscuits & Snacks","Noodles & Pasta",
    "Dairy & Bakery","Pickles & Chutneys",
    "Cleaning & Household","Personal Care",
    "Baby Care","Stationery"
  ],
  catImg:{
    "Top Deals":"https://images.unsplash.com/photo-1542838132-92c53300491e?auto=format&fit=crop&w=1200&q=60",
    "Atta & Flour":"https://images.unsplash.com/photo-1589923188900-85dae523342b?auto=format&fit=crop&w=1200&q=60",
    "Rice & Grains":"https://images.unsplash.com/photo-1586201375761-83865001e31c?auto=format&fit=crop&w=1200&q=60",
    "Pulses & Beans":"https://images.unsplash.com/photo-1615485290382-441e4d14f1c2?auto=format&fit=crop&w=1200&q=60",
    "Edible Oil & Ghee":"https://images.unsplash.com/photo-1604908176997-431d5c68298d?auto=format&fit=crop&w=1200&q=60",
    "Spices & Masala":"https://images.unsplash.com/photo-1604909052858-1b00c7c01b2b?auto=format&fit=crop&w=1200&q=60",
    "Sugar, Salt & Jaggery":"https://images.unsplash.com/photo-1615486368212-9b9f2f5e5e77?auto=format&fit=crop&w=1200&q=60",
    "Tea, Coffee & Beverages":"https://images.unsplash.com/photo-1514432324607-a09d9b4aefdd?auto=format&fit=crop&w=1200&q=60",
    "Biscuits & Snacks":"https://images.unsplash.com/photo-1604909052866-3b0edc7dfc4d?auto=format&fit=crop&w=1200&q=60",
    "Noodles & Pasta":"https://images.unsplash.com/photo-1528750997573-59b89d56f4f7?auto=format&fit=crop&w=1200&q=60",
    "Dairy & Bakery":"https://images.unsplash.com/photo-1545468258-91c3f9efab9f?auto=format&fit=crop&w=1200&q=60",
    "Pickles & Chutneys":"https://images.unsplash.com/photo-1604909052749-d0f9c83d0f4c?auto=format&fit=crop&w=1200&q=60",
    "Cleaning & Household":"https://images.unsplash.com/photo-1585421514285-efb74c2b69f7?auto=format&fit=crop&w=1200&q=60",
    "Personal Care":"https://images.unsplash.com/photo-1583947215259-38e31be8751f?auto=format&fit=crop&w=1200&q=60",
    "Baby Care":"https://images.unsplash.com/photo-1596461404969-9ae70f2830c1?auto=format&fit=crop&w=1200&q=60",
    "Stationery":"https://images.unsplash.com/photo-1456735190827-d1262f71b8a3?auto=format&fit=crop&w=1200&q=60"
  },
  baseProducts:[
    {id:"d1", sellerId:"UKMART_STORE", name:"Combo: Rice 5kg + Oil 1L", cat:"Top Deals", base:599, status:"available", img:"https://images.unsplash.com/photo-1586201375761-83865001e31c?auto=format&fit=crop&w=1200&q=60"},
    {id:"d2", sellerId:"UKMART_STORE", name:"Combo: Atta 10kg + Sugar 2kg", cat:"Top Deals", base:699, status:"available", img:"https://images.unsplash.com/photo-1589923188900-85dae523342b?auto=format&fit=crop&w=1200&q=60"},
    {id:"d3", sellerId:"UKMART_STORE", name:"Combo: Soap pack + Detergent", cat:"Top Deals", base:349, status:"available", img:"https://images.unsplash.com/photo-1583947215259-38e31be8751f?auto=format&fit=crop&w=1200&q=60"},
    {id:"a1", sellerId:"UKMART_STORE", name:"Wheat Atta 5kg", cat:"Atta & Flour", base:255, status:"available"},
    {id:"a2", sellerId:"UKMART_STORE", name:"Wheat Atta 10kg", cat:"Atta & Flour", base:499, status:"available"},
    {id:"a3", sellerId:"UKMART_STORE", name:"Maida 1kg", cat:"Atta & Flour", base:52, status:"available"},
    {id:"a4", sellerId:"UKMART_STORE", name:"Besan 1kg", cat:"Atta & Flour", base:88, status:"available"},
    {id:"a5", sellerId:"UKMART_STORE", name:"Sooji/Rava 1kg", cat:"Atta & Flour", base:62, status:"available"},
    {id:"a6", sellerId:"UKMART_STORE", name:"Poha 1kg", cat:"Atta & Flour", base:55, status:"available"},
    {id:"a7", sellerId:"UKMART_STORE", name:"Dalia 1kg", cat:"Atta & Flour", base:58, status:"available"},
    {id:"r1", sellerId:"UKMART_STORE", name:"Rice 1kg", cat:"Rice & Grains", base:52, status:"available"},
    {id:"r2", sellerId:"UKMART_STORE", name:"Basmati Rice 1kg", cat:"Rice & Grains", base:125, status:"available"},
    {id:"r3", sellerId:"UKMART_STORE", name:"Rice 5kg", cat:"Rice & Grains", base:245, status:"available"},
    {id:"r4", sellerId:"UKMART_STORE", name:"Wheat 5kg", cat:"Rice & Grains", base:219, status:"available"},
    {id:"r5", sellerId:"UKMART_STORE", name:"Jowar 1kg", cat:"Rice & Grains", base:78, status:"available"},
    {id:"r6", sellerId:"UKMART_STORE", name:"Bajra 1kg", cat:"Rice & Grains", base:72, status:"available"},
    {id:"r7", sellerId:"UKMART_STORE", name:"Oats 1kg", cat:"Rice & Grains", base:185, status:"available"},
    {id:"r8", sellerId:"UKMART_STORE", name:"Corn Flour 1kg", cat:"Rice & Grains", base:84, status:"available"},
    {id:"p1", sellerId:"UKMART_STORE", name:"Toor Dal 1kg", cat:"Pulses & Beans", base:140, status:"available"},
    {id:"p2", sellerId:"UKMART_STORE", name:"Masoor Dal 1kg", cat:"Pulses & Beans", base:118, status:"available"},
    {id:"p3", sellerId:"UKMART_STORE", name:"Moong Dal 1kg", cat:"Pulses & Beans", base:132, status:"available"},
    {id:"p4", sellerId:"UKMART_STORE", name:"Chana Dal 1kg", cat:"Pulses & Beans", base:98, status:"available"},
    {id:"p5", sellerId:"UKMART_STORE", name:"Rajma 1kg", cat:"Pulses & Beans", base:145, status:"available"},
    {id:"p6", sellerId:"UKMART_STORE", name:"Kabuli Chana 1kg", cat:"Pulses & Beans", base:128, status:"available"},
    {id:"p7", sellerId:"UKMART_STORE", name:"Soya Chunks 1kg", cat:"Pulses & Beans", base:149, status:"available"},
    {id:"o1", sellerId:"UKMART_STORE", name:"Mustard Oil 1L", cat:"Edible Oil & Ghee", base:152, status:"available"},
    {id:"o2", sellerId:"UKMART_STORE", name:"Soybean Oil 1L", cat:"Edible Oil & Ghee", base:145, status:"available"},
    {id:"o3", sellerId:"UKMART_STORE", name:"Refined Oil 1L", cat:"Edible Oil & Ghee", base:148, status:"available"},
    {id:"o4", sellerId:"UKMART_STORE", name:"Ghee 500ml", cat:"Edible Oil & Ghee", base:299, status:"available"},
    {id:"o5", sellerId:"UKMART_STORE", name:"Ghee 1L", cat:"Edible Oil & Ghee", base:565, status:"available"},
    {id:"o6", sellerId:"UKMART_STORE", name:"Coconut Oil 200ml", cat:"Edible Oil & Ghee", base:110, status:"out"},
    {id:"s1", sellerId:"UKMART_STORE", name:"Turmeric Powder 200g", cat:"Spices & Masala", base:58, status:"available"},
    {id:"s2", sellerId:"UKMART_STORE", name:"Red Chilli Powder 200g", cat:"Spices & Masala", base:78, status:"available"},
    {id:"s3", sellerId:"UKMART_STORE", name:"Coriander Powder 200g", cat:"Spices & Masala", base:68, status:"available"},
    {id:"s4", sellerId:"UKMART_STORE", name:"Garam Masala 100g", cat:"Spices & Masala", base:65, status:"available"},
    {id:"s5", sellerId:"UKMART_STORE", name:"Jeera 200g", cat:"Spices & Masala", base:92, status:"available"},
    {id:"s6", sellerId:"UKMART_STORE", name:"Black Pepper 50g", cat:"Spices & Masala", base:85, status:"available"},
    {id:"s7", sellerId:"UKMART_STORE", name:"Mustard Seeds 200g", cat:"Spices & Masala", base:45, status:"available"},
    {id:"s8", sellerId:"UKMART_STORE", name:"Hing 10g", cat:"Spices & Masala", base:42, status:"available"},
    {id:"ss1", sellerId:"UKMART_STORE", name:"Sugar 1kg", cat:"Sugar, Salt & Jaggery", base:46, status:"available"},
    {id:"ss2", sellerId:"UKMART_STORE", name:"Rock Salt 1kg", cat:"Sugar, Salt & Jaggery", base:38, status:"available"},
    {id:"ss3", sellerId:"UKMART_STORE", name:"Iodized Salt 1kg", cat:"Sugar, Salt & Jaggery", base:24, status:"available"},
    {id:"ss4", sellerId:"UKMART_STORE", name:"Jaggery/Gud 1kg", cat:"Sugar, Salt & Jaggery", base:62, status:"available"},
    {id:"ss5", sellerId:"UKMART_STORE", name:"Tea Sugar 500g", cat:"Sugar, Salt & Jaggery", base:28, status:"available"},
    {id:"b1", sellerId:"UKMART_STORE", name:"Tea 250g", cat:"Tea, Coffee & Beverages", base:118, status:"available"},
    {id:"b2", sellerId:"UKMART_STORE", name:"Tea 500g", cat:"Tea, Coffee & Beverages", base:225, status:"available"},
    {id:"b3", sellerId:"UKMART_STORE", name:"Instant Coffee 100g", cat:"Tea, Coffee & Beverages", base:180, status:"available"},
    {id:"b4", sellerId:"UKMART_STORE", name:"Health Drink 500g", cat:"Tea, Coffee & Beverages", base:259, status:"unavailable"},
    {id:"b5", sellerId:"UKMART_STORE", name:"Soft Drink 2L", cat:"Tea, Coffee & Beverages", base:105, status:"available"},
    {id:"b6", sellerId:"UKMART_STORE", name:"Packaged Water 1L", cat:"Tea, Coffee & Beverages", base:20, status:"available"},
    {id:"sn1", sellerId:"UKMART_STORE", name:"Biscuit Pack", cat:"Biscuits & Snacks", base:30, status:"available"},
    {id:"sn2", sellerId:"UKMART_STORE", name:"Namkeen 400g", cat:"Biscuits & Snacks", base:85, status:"available"},
    {id:"sn3", sellerId:"UKMART_STORE", name:"Chips Family Pack", cat:"Biscuits & Snacks", base:55, status:"available"},
    {id:"sn4", sellerId:"UKMART_STORE", name:"Dry Fruits Mix 200g", cat:"Biscuits & Snacks", base:180, status:"available"},
    {id:"sn5", sellerId:"UKMART_STORE", name:"Peanuts 500g", cat:"Biscuits & Snacks", base:75, status:"available"},
    {id:"n1", sellerId:"UKMART_STORE", name:"Instant Noodles Pack", cat:"Noodles & Pasta", base:65, status:"available"},
    {id:"n2", sellerId:"UKMART_STORE", name:"Pasta 500g", cat:"Noodles & Pasta", base:78, status:"available"},
    {id:"n3", sellerId:"UKMART_STORE", name:"Macaroni 500g", cat:"Noodles & Pasta", base:82, status:"available"},
    {id:"n4", sellerId:"UKMART_STORE", name:"Vermicelli 500g", cat:"Noodles & Pasta", base:55, status:"available"},
    {id:"d11", sellerId:"UKMART_STORE", name:"Milk 1L", cat:"Dairy & Bakery", base:58, status:"available", img:"https://images.unsplash.com/photo-1550583724-b2692b85b150?auto=format&fit=crop&w=1200&q=60"},
    {id:"d12", sellerId:"UKMART_STORE", name:"Curd 500g", cat:"Dairy & Bakery", base:45, status:"available", img:"https://images.unsplash.com/photo-1604909052709-0a9c2b951376?auto=format&fit=crop&w=1200&q=60"},
    {id:"d13", sellerId:"UKMART_STORE", name:"Butter 100g", cat:"Dairy & Bakery", base:58, status:"available", img:"https://images.unsplash.com/photo-1588167056547-5d29a1b234bd?auto=format&fit=crop&w=1200&q=60"},
    {id:"d14", sellerId:"UKMART_STORE", name:"Bread", cat:"Dairy & Bakery", base:40, status:"available", img:"https://images.unsplash.com/photo-1549931319-a545dcf3bc73?auto=format&fit=crop&w=1200&q=60"},
    {id:"d15", sellerId:"UKMART_STORE", name:"Paneer 200g", cat:"Dairy & Bakery", base:85, status:"out", img:"https://images.unsplash.com/photo-1625858269453-27c1c0b71a7b?auto=format&fit=crop&w=1200&q=60"},
    {id:"pk1", sellerId:"UKMART_STORE", name:"Mango Pickle 400g", cat:"Pickles & Chutneys", base:85, status:"available"},
    {id:"pk2", sellerId:"UKMART_STORE", name:"Mixed Pickle 400g", cat:"Pickles & Chutneys", base:88, status:"available"},
    {id:"pk3", sellerId:"UKMART_STORE", name:"Tomato Ketchup 900g", cat:"Pickles & Chutneys", base:120, status:"available"},
    {id:"c1", sellerId:"UKMART_STORE", name:"Detergent Powder 1kg", cat:"Cleaning & Household", base:95, status:"available"},
    {id:"c2", sellerId:"UKMART_STORE", name:"Dishwash Liquid 500ml", cat:"Cleaning & Household", base:110, status:"available"},
    {id:"c3", sellerId:"UKMART_STORE", name:"Floor Cleaner 1L", cat:"Cleaning & Household", base:125, status:"available"},
    {id:"c4", sellerId:"UKMART_STORE", name:"Toilet Cleaner 500ml", cat:"Cleaning & Household", base:89, status:"available"},
    {id:"c5", sellerId:"UKMART_STORE", name:"Garbage Bags (Pack)", cat:"Cleaning & Household", base:65, status:"available"},
    {id:"c6", sellerId:"UKMART_STORE", name:"Tissues (Pack)", cat:"Cleaning & Household", base:55, status:"available"},
    {id:"pc1", sellerId:"UKMART_STORE", name:"Bath Soap (Pack)", cat:"Personal Care", base:98, status:"available"},
    {id:"pc2", sellerId:"UKMART_STORE", name:"Shampoo 180ml", cat:"Personal Care", base:120, status:"available"},
    {id:"pc3", sellerId:"UKMART_STORE", name:"Toothpaste 200g", cat:"Personal Care", base:95, status:"available"},
    {id:"pc4", sellerId:"UKMART_STORE", name:"Toothbrush (Pack)", cat:"Personal Care", base:65, status:"available"},
    {id:"pc5", sellerId:"UKMART_STORE", name:"Hair Oil 200ml", cat:"Personal Care", base:110, status:"available"},
    {id:"pc6", sellerId:"UKMART_STORE", name:"Face Wash 100ml", cat:"Personal Care", base:125, status:"available"},
    {id:"bc1", sellerId:"UKMART_STORE", name:"Baby Diapers (Small pack)", cat:"Baby Care", base:299, status:"available"},
    {id:"bc2", sellerId:"UKMART_STORE", name:"Baby Wipes (Pack)", cat:"Baby Care", base:99, status:"available"},
    {id:"bc3", sellerId:"UKMART_STORE", name:"Baby Soap", cat:"Baby Care", base:55, status:"available"},
    {id:"st1", sellerId:"UKMART_STORE", name:"Notebook", cat:"Stationery", base:45, status:"available"},
    {id:"st2", sellerId:"UKMART_STORE", name:"Pen (Pack)", cat:"Stationery", base:35, status:"available"},
    {id:"st3", sellerId:"UKMART_STORE", name:"Marker (Pack)", cat:"Stationery", base:60, status:"available"}
  ]
};

function ensureImages(products){
  return products.map(p=>{
    if(p.img) return p;
    return {...p, img: Catalog.catImg[p.cat] || Catalog.catImg["Top Deals"]};
  });
}

/* ========= App State ========= */
const App = {
  state:{ activeCat:"Top Deals", q:"" },
  init(){
    document.getElementById("year").textContent = new Date().getFullYear();
    document.getElementById("marketIndex").textContent = Market.index().toFixed(2);

    if(LS.get("lang", null)===null) LS.set("lang","en");
    if(LS.get("area", null)===null) LS.set("area","");

    // Tracking defaults
    Tracking.ensureDefaults();

    App.refreshArea();
    App.renderCatChips();
    App.render();

    document.getElementById("spCat").innerHTML = Catalog.categories
      .filter(c=>c!=="Top Deals")
      .map(c=>`<option>${c}</option>`).join("");

    Admin.ensureDefaults();
    Cart.render();

    // default menu highlight
    Nav.setActive("home");

    // Listen live driver updates from other tabs/windows
    Tracking.listen();
  },
  refreshArea(){
    const area = LS.get("area","");
    document.getElementById("areaLabel").textContent = area || "Not set";
  },
  allProducts(){
    const seller = ensureImages(LS.get("sellerProducts", []));
    const base = ensureImages(Catalog.baseProducts);
    const map = new Map();
    [...base, ...seller].forEach(p=>map.set(p.id,p));
    return [...map.values()];
  },
  search(){
    App.state.q = (document.getElementById("q").value||"").trim();
    App.render();
  },
  reset(){
    App.state.activeCat = "Top Deals";
    App.state.q = "";
    document.getElementById("q").value = "";
    document.getElementById("stockFilter").value = "all";
    App.renderCatChips();
    App.render();
  },
  renderCatChips(){
    const wrap = document.getElementById("catChips");
    wrap.innerHTML = "";
    Catalog.categories.forEach(cat=>{
      const b = document.createElement("button");
      b.className = "chip" + (App.state.activeCat===cat ? " active": "");
      b.textContent = cat;
      b.onclick = ()=>{
        App.state.activeCat = cat;
        App.renderCatChips();
        UI.scrollTo("products");
        App.render();
      };
      wrap.appendChild(b);
    });
  },
  tagHTML(status){
    if(status==="available") return `<span class="tag good">Available</span>`;
    if(status==="out") return `<span class="tag warn">Out of stock</span>`;
    return `<span class="tag bad">Unavailable</span>`;
  },
  productCardHTML(p){
    const price = Market.price(p.base, p.cat);
    const disabled = (p.status!=="available");
    const inCart = Cart.qty(p.id);
    return `
      <div class="pCard">
        <img class="pImg" src="${p.img}" alt="${p.name}" loading="lazy">
        <div class="pad">
          <div class="row">
            <div>
              <div class="name">${p.name}</div>
              <div class="cat">${p.cat}</div>
            </div>
            ${App.tagHTML(p.status)}
          </div>

          <div class="row" style="margin-top:10px;align-items:center">
            <div class="price">₹${price}</div>
            <div class="qty">
              <button onclick="Cart.dec('${p.id}')" ${inCart<=0 ? "disabled":""}>−</button>
              <div class="num">${inCart}</div>
              <button onclick="Cart.inc('${p.id}')" ${disabled ? "disabled":""}>+</button>
            </div>
          </div>
        </div>
      </div>
    `;
  },
  render(){
    const stockFilter = document.getElementById("stockFilter").value;
    const q = App.state.q.toLowerCase();

    let products = App.allProducts();
    if(q){
      products = products.filter(p=>{
        const hay = (p.name + " " + p.cat).toLowerCase();
        return hay.includes(q);
      });
    }
    if(stockFilter !== "all"){
      products = products.filter(p=>p.status===stockFilter);
    }

    const byCat = new Map();
    Catalog.categories.forEach(c=>byCat.set(c, []));
    products.forEach(p=>{
      if(!byCat.has(p.cat)) byCat.set(p.cat, []);
      byCat.get(p.cat).push(p);
    });

    let orderCats = [...Catalog.categories];
    if(!q){
      orderCats = [App.state.activeCat, ...orderCats.filter(c=>c!==App.state.activeCat)];
    } else {
      orderCats = orderCats.filter(c=>(byCat.get(c)||[]).length>0);
    }

    const sections = document.getElementById("sections");
    sections.innerHTML = "";

    orderCats.forEach(cat=>{
      const list = byCat.get(cat) || [];
      if(q && list.length===0) return;

      const rowItems = list.slice(0, 12);

      const sec = document.createElement("section");
      sec.className = "section";
      sec.id = "sec-"+cat.replace(/\W+/g,'_');

      sec.innerHTML = `
        <div class="sectionHead">
          <div>
            <h2>${cat}</h2>
            <div class="tiny">${list.length} items</div>
          </div>
          <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
            <button class="btn" onclick="App.openSeeAll('${cat.replace(/'/g,"\\'")}')">See all</button>
          </div>
        </div>
        <div class="rowWrap">
          <div class="hRow">
            ${rowItems.map(p=>App.productCardHTML(p)).join("") || `<div class="muted" style="font-weight:1000">No items</div>`}
          </div>
          <div class="tiny">Tip: swipe/scroll horizontally →</div>
        </div>
      `;
      sections.appendChild(sec);
    });

    Cart.renderTotals();
  },
  openSeeAll(cat){
    const stockFilter = document.getElementById("stockFilter").value;
    const q = App.state.q.toLowerCase();

    let products = App.allProducts().filter(p=>p.cat===cat);
    if(q){
      products = products.filter(p=>{
        const hay = (p.name + " " + p.cat).toLowerCase();
        return hay.includes(q);
      });
    }
    if(stockFilter !== "all"){
      products = products.filter(p=>p.status===stockFilter);
    }

    document.getElementById("seeAllTitle").textContent = `${cat} — All products`;
    document.getElementById("seeAllHint").textContent = q ? `Filtered by search: "${App.state.q}"` : `Browse all items in ${cat}`;

    const grid = document.getElementById("seeAllGrid");
    grid.innerHTML = products.map(p=>App.productCardHTML(p)).join("") || `<div class="muted" style="font-weight:1000">No products found.</div>`;

    Modal.open("seeall");
  }
};

/* ========= Cart ========= */
const Cart = {
  get(){ return LS.get("cart", {}); },
  set(c){ LS.set("cart", c); },
  qty(pid){ const c=Cart.get(); return Number(c[pid]||0); },
  inc(pid){
    const p = App.allProducts().find(x=>x.id===pid);
    if(!p || p.status!=="available") return;
    const c = Cart.get();
    c[pid] = (c[pid]||0) + 1;
    Cart.set(c);
    App.render();
    Cart.render();
  },
  dec(pid){
    const c = Cart.get();
    c[pid] = (c[pid]||0) - 1;
    if(c[pid] <= 0) delete c[pid];
    Cart.set(c);
    App.render();
    Cart.render();
  },
  clear(){
    Cart.set({});
    App.render();
    Cart.render();
  },
  subtotal(){
    const c=Cart.get();
    const prods=App.allProducts();
    let sum=0;
    for(const pid in c){
      const p = prods.find(x=>x.id===pid);
      if(!p) continue;
      const qty = Number(c[pid]||0);
      sum += Market.price(p.base, p.cat) * qty;
    }
    return sum;
  },
  tax(subtotal){ return Math.round(subtotal*0.02); },
  render(){
    const wrap=document.getElementById("basketItems");
    const c=Cart.get();
    const prods=App.allProducts();
    const entries=Object.keys(c);

    if(entries.length===0){
      wrap.innerHTML = `<div class="muted" style="font-weight:1000">Basket is empty.</div>`;
      Cart.renderTotals();
      return;
    }

    wrap.innerHTML = entries.map(pid=>{
      const p = prods.find(x=>x.id===pid);
      if(!p) return "";
      const qty = Number(c[pid]||0);
      const unit = Market.price(p.base, p.cat);

      return `
        <div class="basketItem">
          <img src="${p.img}" alt="${p.name}" loading="lazy">
          <div class="info">
            <div class="t">${p.name}</div>
            <div class="s">${qty} × ₹${unit} = <b>₹${qty*unit}</b></div>
          </div>
          <div class="qty">
            <button onclick="Cart.dec('${p.id}')">−</button>
            <div class="num">${qty}</div>
            <button onclick="Cart.inc('${p.id}')" ${p.status!=="available" ? "disabled":""}>+</button>
          </div>
        </div>
      `;
    }).join("");

    Cart.renderTotals();
  },
  renderTotals(){
    const sub = Cart.subtotal();
    const tax = Cart.tax(sub);
    const grand = sub + tax;

    document.getElementById("subTotal").textContent = "₹" + sub;
    document.getElementById("taxTotal").textContent = "₹" + tax;
    document.getElementById("grandTotal").textContent = "₹" + grand;
  }
};

/* ========= Invoice PDF ========= */
const InvoicePDF = {
  download({orderId,time,area,items,sub,tax,grand}){
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const margin=14;
    let y=14;

    doc.setFont("helvetica","bold");
    doc.setFontSize(16);
    doc.text("UK Mart — Invoice", margin, y);

    doc.setFont("helvetica","normal");
    doc.setFontSize(11);
    y+=8;
    doc.text(`Invoice No: ${orderId}`, margin, y); y+=6;
    doc.text(`Date: ${new Date(time).toLocaleString()}`, margin, y); y+=6;
    doc.text(`Area: ${area}`, margin, y);

    y+=10;
    doc.setFont("helvetica","bold");
    doc.text("Items", margin, y); y+=6;

    doc.setFont("helvetica","bold");
    doc.text("Product", margin, y);
    doc.text("Qty", 120, y);
    doc.text("Price", 140, y);
    doc.text("Total", 196, y, {align:"right"});
    y+=4;
    doc.setDrawColor(200);
    doc.line(margin, y, 196, y);
    y+=6;

    doc.setFont("helvetica","normal");
    items.forEach(it=>{
      if(y>270){ doc.addPage(); y=14; }
      doc.text(String(it.name).slice(0,34), margin, y);
      doc.text(String(it.qty), 122, y);
      doc.text(`₹${it.unit}`, 140, y);
      doc.text(`₹${it.total}`, 196, y, {align:"right"});
      y+=7;
    });

    y+=4;
    doc.line(margin, y, 196, y);
    y+=8;

    doc.setFont("helvetica","bold");
    doc.text(`Subtotal: ₹${sub}`, 196, y, {align:"right"}); y+=7;
    doc.text(`Tax/Handling: ₹${tax}`, 196, y, {align:"right"}); y+=7;
    doc.text(`Grand Total: ₹${grand}`, 196, y, {align:"right"});

    y+=12;
    doc.setFont("helvetica","normal");
    doc.setFontSize(10);
    doc.text("Thank you for shopping with UK Mart.", margin, y);

    doc.save(`UKMart_Invoice_${orderId}.pdf`);
  }
};

/* ========= Orders + Commission ========= */
const Orders = {
  placeFromCart(){
    const cart = Cart.get();
    const pids = Object.keys(cart);
    if(pids.length===0){ alert("Basket is empty."); return; }

    const all = App.allProducts();
    const commissionPct = Admin.getCommissionPct();
    const now = Date.now();
    const orderId = "UKM-" + String(now).slice(-8);

    let orders = LS.get("orders", []);
    let items = [];
    let sub = 0;

    for(const pid of pids){
      const p = all.find(x=>x.id===pid);
      if(!p || p.status!=="available") continue;

      const qty = Number(cart[pid]||0);
      const unit = Market.price(p.base, p.cat);
      const total = unit * qty;
      const commission = Math.round(total * (commissionPct/100));

      orders.push({t:now, orderId, pid, sellerId:p.sellerId, name:p.name, qty, unit, total, commission});
      items.push({name:p.name, qty, unit, total});
      sub += total;
    }

    LS.set("orders", orders);

    const tax = Cart.tax(sub);
    const grand = sub + tax;
    const area = LS.get("area","Not set");

    // When order placed, set a demo "active delivery"
    Tracking.createDeliveryFromArea(area);

    Cart.clear();
    Admin.refresh();

    InvoicePDF.download({orderId, time:now, area, items, sub, tax, grand});
    alert("Order placed. Invoice PDF downloaded. Open Live Tracking to track delivery.");
  }
};

/* ========= Account ========= */
const Account = {
  refresh(){
    const box=document.getElementById("accountStatus");
    const me=LS.get("me", null);
    box.innerHTML = me
      ? `Logged in as <b>${me.name}</b> (${me.role}) — <span style="color:#64748b;font-weight:1000">${me.id}</span>`
      : "Not logged in.";
  },
  register(){
    const name=document.getElementById("regName").value.trim();
    const id=document.getElementById("regId").value.trim();
    const pass=document.getElementById("regPass").value;
    const role=document.getElementById("regRole").value;
    if(!name||!id||!pass){ alert("Please fill all fields."); return; }
    const users=LS.get("users",[]);
    if(users.find(u=>u.id===id)){ alert("User already exists."); return; }
    users.push({name,id,pass,role});
    LS.set("users",users);
    alert("Account created! Now login.");
  },
  login(){
    const id=document.getElementById("loginId").value.trim();
    const pass=document.getElementById("loginPass").value;
    const users=LS.get("users",[]);
    const u=users.find(x=>x.id===id && x.pass===pass);
    if(!u){ alert("Wrong login."); return; }
    LS.set("me",{name:u.name,id:u.id,role:u.role});
    Account.refresh();
  },
  logout(){ LS.del("me"); Account.refresh(); }
};

/* ========= Settings ========= */
const Settings = {
  setArea(area){ LS.set("area", area); App.refreshArea(); },
  setLang(lang){ LS.set("lang", lang); alert("Language saved (UI remains English in this single-file version)."); },
  refresh(){
    document.getElementById("areaSelect").value = LS.get("area","");
    document.getElementById("langSelect").value = LS.get("lang","en");
  }
};

/* ========= Seller ========= */
const Seller = {
  refresh(){
    const me=LS.get("me",null);
    const list=ensureImages(LS.get("sellerProducts",[]));
    const my = me ? list.filter(p=>p.sellerId===me.id) : [];
    const body=document.getElementById("sellerTable");
    body.innerHTML = my.map(p=>`
      <tr><td>${p.name}</td><td>${p.status}</td><td>₹${p.base}</td></tr>
    `).join("") || `<tr><td colspan="3" class="muted">No vendor products.</td></tr>`;

    const feeBox=document.getElementById("vendorFeeBox");
    if(!me || me.role!=="seller"){
      feeBox.textContent = "Login as Vendor to view vendor fee details.";
      return;
    }
    const start=VendorFee.initTrialForSeller(me.id);
    const days=VendorFee.daysSince(start);

    const orders=LS.get("orders",[]);
    const myOrders=orders.filter(o=>o.sellerId===me.id);
    const sales=myOrders.reduce((s,o)=>s+o.total,0);
    const commissionOnMy=myOrders.reduce((s,o)=>s+o.commission,0);
    const profit=Math.max(0, sales - commissionOnMy);
    const feeDue=VendorFee.feeDue(profit, days);

    feeBox.innerHTML = `
      <div><b>Trial days used:</b> ${days} / 90</div>
      <div><b>Sales (demo):</b> ₹${sales}</div>
      <div><b>Admin commission on your sales:</b> ₹${commissionOnMy}</div>
      <div><b>Profit (demo):</b> ₹${profit}</div>
      <div style="margin-top:8px"><b>Vendor fee due:</b> ${feeDue>0 ? "₹"+feeDue+" (hidden)" : "₹0 (trial active)"}</div>
      <div style="margin-top:8px;color:#64748b">Real fee settlement needs backend.</div>
    `;
  },
  add(){
    const me=LS.get("me",null);
    if(!me || me.role!=="seller"){ alert("Please login as Vendor in Account."); return; }

    const name=document.getElementById("spName").value.trim();
    const cat=document.getElementById("spCat").value;
    const base=Number(document.getElementById("spPrice").value||0);
    const status=document.getElementById("spStatus").value;
    const img=(document.getElementById("spImg").value||"").trim();

    if(!name || !cat || !base){ alert("Fill product name, category, and base price."); return; }

    const id="v_"+Math.random().toString(16).slice(2,10);
    const item={
      id, sellerId: me.id,
      name, cat, base, status,
      img: img || (Catalog.catImg[cat] || Catalog.catImg["Top Deals"])
    };

    const list=ensureImages(LS.get("sellerProducts",[]));
    list.push(item);
    LS.set("sellerProducts", list);

    document.getElementById("sellerMsg").textContent = "Saved. Product is now visible on the main page.";
    Seller.refresh();
    App.render();
  },
  clearMine(){
    const me=LS.get("me",null);
    if(!me){ alert("Login first."); return; }
    const list=ensureImages(LS.get("sellerProducts",[]));
    LS.set("sellerProducts", list.filter(p=>p.sellerId!==me.id));
    Seller.refresh();
    App.render();
  }
};

/* ========= Admin ========= */
const Admin = {
  ensureDefaults(){
    if(LS.get("commissionMode",null)===null) LS.set("commissionMode","auto");
    if(LS.get("commissionPctManual",null)===null) LS.set("commissionPctManual",5);
  },
  applyMode(){
    LS.set("commissionMode", document.getElementById("commissionMode").value);
    Admin.refresh();
  },
  getCommissionPct(){
    const mode=LS.get("commissionMode","auto");
    return (mode==="auto") ? Market.autoCommissionPct() : Number(LS.get("commissionPctManual",5));
  },
  save(){
    LS.set("commissionMode", document.getElementById("commissionMode").value);
    LS.set("commissionPctManual", Number(document.getElementById("commissionPct").value||0));
    alert("Commission settings saved.");
    Admin.refresh();
  },
  clearOrders(){ LS.set("orders",[]); Admin.refresh(); },
  refresh(){
    const mode=LS.get("commissionMode","auto");
    const manual=Number(LS.get("commissionPctManual",5));
    const effective=Admin.getCommissionPct();

    const modeEl=document.getElementById("commissionMode");
    const pctEl=document.getElementById("commissionPct");
    modeEl.value=mode;
    pctEl.value=(mode==="auto")?effective:manual;
    pctEl.disabled=(mode==="auto");

    const orders=LS.get("orders",[]);
    const totalOrders=orders.length;
    const sales=orders.reduce((s,o)=>s+o.total,0);
    const comm=orders.reduce((s,o)=>s+o.commission,0);

    document.getElementById("admOrders").textContent=totalOrders;
    document.getElementById("admSales").textContent="₹"+sales;
    document.getElementById("admComm").textContent="₹"+comm;

    const body=document.getElementById("ordersTable");
    body.innerHTML = orders.slice().reverse().map(o=>`
      <tr>
        <td>${new Date(o.t).toLocaleString()}</td>
        <td>${o.name}</td>
        <td>${o.qty}</td>
        <td>₹${o.total}</td>
        <td>₹${o.commission}</td>
      </tr>
    `).join("") || `<tr><td colspan="5" class="muted">No orders yet.</td></tr>`;
  }
};

/* ========= Live Tracking (Leaflet + Geolocation + BroadcastChannel/localStorage) ========= */
const Tracking = {
  // store keys
  KEY_ROUTE: "ukmart.route",
  KEY_DRIVER: "ukmart.driver.live",
  bc: null,

  // leaflet instances
  custMap: null,
  driverMap: null,
  markers: {
    pickup:null, drop:null, driver:null,
    line1:null, line2:null
  },

  ensureDefaults(){
    // Default pickup location (your shop). You can change these.
    if(!LS.get(Tracking.KEY_ROUTE, null)){
      LS.set(Tracking.KEY_ROUTE, {
        pickup: { name:"UK Mart Shop", lat:23.799, lng:86.430 },  // edit if needed
        drop:   { name:"Customer",    lat:23.810, lng:86.440 },
        status: "placed"
      });
    }
    if(!LS.get(Tracking.KEY_DRIVER, null)){
      LS.set(Tracking.KEY_DRIVER, {
        name:"", phone:"", lat:null, lng:null, ts:null, status:"idle"
      });
    }
  },

  listen(){
    // BroadcastChannel (best) + fallback storage event
    try{
      Tracking.bc = new BroadcastChannel("ukmart_live");
      Tracking.bc.onmessage = (e)=>{ Tracking.onLiveUpdate(e.data); };
    }catch(e){ /* ignore */ }

    window.addEventListener("storage", (e)=>{
      if(e.key===Tracking.KEY_DRIVER || e.key===Tracking.KEY_ROUTE){
        Tracking.onLiveUpdate({type:"storage"});
      }
    });
  },

  onLiveUpdate(){
    // update customer UI if open
    if(document.getElementById("modal-track").style.display==="block"){
      Tracking.refreshCustomerUI(true);
    }
    // update driver UI if open
    if(document.getElementById("modal-driver").style.display==="block"){
      Driver.refreshUI();
    }
  },

  notify(data){
    try{ if(Tracking.bc) Tracking.bc.postMessage(data); }catch(e){}
  },

  openCustomer(){
    setTimeout(()=>{
      Tracking.initCustomerMap();
      Tracking.refreshCustomerUI(true);
    }, 50);
  },

  initCustomerMap(){
    if(Tracking.custMap) return;

    const route = LS.get(Tracking.KEY_ROUTE, {});
    const center = route.pickup ? [route.pickup.lat, route.pickup.lng] : [23.8, 86.43];

    Tracking.custMap = L.map("customerMap").setView(center, 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap"
    }).addTo(Tracking.custMap);

    Tracking.renderMap("customer");
  },

  initDriverMap(){
    if(Tracking.driverMap) return;

    const route = LS.get(Tracking.KEY_ROUTE, {});
    const center = route.pickup ? [route.pickup.lat, route.pickup.lng] : [23.8, 86.43];

    Tracking.driverMap = L.map("driverMap").setView(center, 13);
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "© OpenStreetMap"
    }).addTo(Tracking.driverMap);

    Tracking.renderMap("driver");
  },

  renderMap(which){
    const route = LS.get(Tracking.KEY_ROUTE, {});
    const driver = LS.get(Tracking.KEY_DRIVER, {});

    const map = (which==="customer") ? Tracking.custMap : Tracking.driverMap;
    if(!map) return;

    // cleanup old markers/lines
    const m = Tracking.markers;
    ["pickup","drop","driver","line1","line2"].forEach(k=>{
      if(m[k] && map.hasLayer(m[k])) map.removeLayer(m[k]);
      m[k]=null;
    });

    const pickup = route.pickup;
    const drop = route.drop;

    if(pickup){
      m.pickup = L.marker([pickup.lat, pickup.lng]).addTo(map).bindPopup(`Pickup: ${pickup.name}`);
    }
    if(drop){
      m.drop = L.marker([drop.lat, drop.lng]).addTo(map).bindPopup(`Delivery: ${drop.name}`);
    }
    if(driver.lat && driver.lng){
      m.driver = L.circleMarker([driver.lat, driver.lng], {radius:10}).addTo(map)
        .bindPopup(`Driver: ${driver.name || "—"}`);
    }

    // lines
    if(pickup && driver.lat && driver.lng){
      m.line1 = L.polyline([[pickup.lat,pickup.lng],[driver.lat,driver.lng]], {weight:4}).addTo(map);
    }
    if(driver.lat && driver.lng && drop){
      m.line2 = L.polyline([[driver.lat,driver.lng],[drop.lat,drop.lng]], {weight:4}).addTo(map);
    }

    // fit bounds
    const pts = [];
    if(pickup) pts.push([pickup.lat,pickup.lng]);
    if(drop) pts.push([drop.lat,drop.lng]);
    if(driver.lat && driver.lng) pts.push([driver.lat,driver.lng]);
    if(pts.length>=2){
      map.fitBounds(pts, {padding:[30,30]});
    } else if(pts.length===1){
      map.setView(pts[0], 14);
    }
  },

  refreshCustomerUI(updateMap=false){
    const route = LS.get(Tracking.KEY_ROUTE, {});
    const driver = LS.get(Tracking.KEY_DRIVER, {});
    const msg = document.getElementById("custTrackMsg");

    const pickup = route.pickup;
    const drop = route.drop;

    document.getElementById("pickupLabel").textContent = pickup ? `${pickup.lat.toFixed(4)}, ${pickup.lng.toFixed(4)}` : "—";
    document.getElementById("dropLabel").textContent = drop ? `${drop.lat.toFixed(4)}, ${drop.lng.toFixed(4)}` : "—";

    document.getElementById("driverLabel").textContent =
      (driver.lat && driver.lng) ? `${(driver.name||"Driver")} • ${driver.lat.toFixed(4)}, ${driver.lng.toFixed(4)}` : "Not connected";
    document.getElementById("driverPhoneLabel").textContent = driver.phone || "—";

    // show input defaults
    if(drop){
      document.getElementById("dropLat").value = drop.lat;
      document.getElementById("dropLng").value = drop.lng;
    }

    // ETA
    let eta = "—";
    if(driver.lat && driver.lng && drop){
      const km = Tracking.haversineKm(driver.lat, driver.lng, drop.lat, drop.lng);
      const speedKmh = 18; // demo speed in city
      const minutes = Math.max(2, Math.round((km/speedKmh)*60));
      eta = `${minutes} min (approx)`;
      if(minutes<=5) eta += " • arriving soon";
    }
    document.getElementById("etaLabel").textContent = eta;

    // message + map updates
    msg.textContent = (driver.lat && driver.lng)
      ? "Live driver location is updating."
      : "No driver location yet. Ask driver to start sharing from Driver Panel.";

    if(updateMap && Tracking.custMap){
      Tracking.renderMap("customer");
    }
  },

  // distance
  haversineKm(lat1,lng1,lat2,lng2){
    const R=6371;
    const dLat=(lat2-lat1)*Math.PI/180;
    const dLng=(lng2-lng1)*Math.PI/180;
    const a=Math.sin(dLat/2)**2 + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLng/2)**2;
    return 2*R*Math.asin(Math.sqrt(a));
  },

  setDropFromInputs(){
    const lat = Number(document.getElementById("dropLat").value);
    const lng = Number(document.getElementById("dropLng").value);
    if(!Number.isFinite(lat) || !Number.isFinite(lng)){ alert("Enter valid lat/lng"); return; }

    const route = LS.get(Tracking.KEY_ROUTE, {});
    route.drop = { name:"Customer", lat, lng };
    LS.set(Tracking.KEY_ROUTE, route);
    Tracking.notify({type:"route_update"});

    Tracking.refreshCustomerUI(true);
    document.getElementById("custTrackMsg").textContent = "Delivery point updated.";
  },

  useMyLocationAsDrop(){
    if(!navigator.geolocation){ alert("Geolocation not supported"); return; }
    navigator.geolocation.getCurrentPosition((pos)=>{
      const lat = pos.coords.latitude;
      const lng = pos.coords.longitude;
      const route = LS.get(Tracking.KEY_ROUTE, {});
      route.drop = { name:"Customer (my location)", lat, lng };
      LS.set(Tracking.KEY_ROUTE, route);
      Tracking.notify({type:"route_update"});
      Tracking.refreshCustomerUI(true);
      document.getElementById("custTrackMsg").textContent = "Delivery point set to your current location.";
    }, (err)=>{
      alert("Location permission denied / unavailable.");
    }, {enableHighAccuracy:true, timeout:10000});
  },

  resetDemoRoute(){
    LS.set(Tracking.KEY_ROUTE, {
      pickup: { name:"UK Mart Shop", lat:23.799, lng:86.430 },
      drop:   { name:"Customer",    lat:23.810, lng:86.440 },
      status: "placed"
    });
    Tracking.notify({type:"route_update"});
    Tracking.refreshCustomerUI(true);
  },

  createDeliveryFromArea(area){
    // simple demo: sets different drop default per area (edit as you like)
    const pickup = { name:"UK Mart Shop", lat:23.799, lng:86.430 };

    const presets = {
      "Jharsuguda": {lat:21.855, lng:84.006},
      "Brajrajnagar": {lat:21.827, lng:83.916},
      "Dumka": {lat:24.269, lng:87.248},
      "Madhupur": {lat:24.265, lng:86.648}
    };

    const drop = presets[area] ? {name:`Customer (${area})`, ...presets[area]} : {name:"Customer", lat:23.810, lng:86.440};

    LS.set(Tracking.KEY_ROUTE, { pickup, drop, status:"placed" });
    Tracking.notify({type:"route_update"});
  }
};

/* ========= Driver ========= */
const Driver = {
  watchId: null,
  open(){
    setTimeout(()=>{
      Tracking.initDriverMap();
      Driver.refreshUI();
    }, 50);
  },
  refreshUI(){
    const driver = LS.get(Tracking.KEY_DRIVER, {});
    document.getElementById("driverName").value = driver.name || "";
    document.getElementById("driverPhone").value = driver.phone || "";
    document.getElementById("driverStatus").textContent = driver.status || "idle";
    document.getElementById("driverLast").textContent = (driver.lat && driver.lng)
      ? `${driver.lat.toFixed(5)}, ${driver.lng.toFixed(5)}`
      : "—";

    if(Tracking.driverMap){
      Tracking.renderMap("driver");
    }
  },
  start(){
    if(!navigator.geolocation){ alert("Geolocation not supported"); return; }

    const name = document.getElementById("driverName").value.trim() || "Driver";
    const phone = document.getElementById("driverPhone").value.trim() || "";
    const driver = LS.get(Tracking.KEY_DRIVER, {});
    driver.name = name;
    driver.phone = phone;
    driver.status = "sharing";
    LS.set(Tracking.KEY_DRIVER, driver);
    Tracking.notify({type:"driver_profile"});

    document.getElementById("driverMsg").textContent = "Starting GPS… please allow location.";
    document.getElementById("driverStatus").textContent = "sharing";

    // watch position
    Driver.watchId = navigator.geolocation.watchPosition((pos)=>{
      const d = LS.get(Tracking.KEY_DRIVER, {});
      d.lat = pos.coords.latitude;
      d.lng = pos.coords.longitude;
      d.ts = Date.now();
      d.status = "sharing";
      LS.set(Tracking.KEY_DRIVER, d);
      Tracking.notify({type:"driver_location"});
      Driver.refreshUI();
    }, (err)=>{
      document.getElementById("driverMsg").textContent = "GPS error or permission denied.";
      alert("GPS permission denied / unavailable. Use HTTPS and allow location.");
    }, {enableHighAccuracy:true, maximumAge:2000, timeout:10000});
  },
  stop(){
    if(Driver.watchId!==null && navigator.geolocation){
      navigator.geolocation.clearWatch(Driver.watchId);
    }
    Driver.watchId = null;
    const d = LS.get(Tracking.KEY_DRIVER, {});
    d.status = "stopped";
    LS.set(Tracking.KEY_DRIVER, d);
    Tracking.notify({type:"driver_stop"});
    Driver.refreshUI();
    document.getElementById("driverMsg").textContent = "Live sharing stopped.";
  },
  mark(status){
    const route = LS.get(Tracking.KEY_ROUTE, {});
    route.status = status;
    LS.set(Tracking.KEY_ROUTE, route);
    Tracking.notify({type:"route_status"});
    document.getElementById("driverMsg").textContent = `Marked as ${status}. Customer will see update.`;
  }
};

/* ========= Boot ========= */
document.addEventListener("DOMContentLoaded", ()=>{
  App.init();
});
</script>
</body>
</html>
