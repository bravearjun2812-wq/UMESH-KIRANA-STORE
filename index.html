<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0"/>
  <title>Umesh Kirana Store | Dumka</title>

  <style>
    :root{
      --bg:#ffffff;
      --surface:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --line:#e5e7eb;
      --blue:#2563eb;
      --blue2:#1d4ed8;
      --soft:#f8fafc;
      --shadow:0 10px 25px rgba(15,23,42,0.08);
      --shadow2:0 6px 18px rgba(15,23,42,0.06);
      --danger:#ef4444;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    a{color:inherit;text-decoration:none}
    .container{max-width:1180px;margin:0 auto;padding:0 16px}
    .small{color:var(--muted);font-size:13px}

    /* TOP BAR */
    .topbar{
      background:var(--blue);
      color:#fff;
      font-size:13px;
    }
    .topbar .wrap{
      display:flex;gap:10px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      padding:10px 0;
    }
    .topbar a{color:#fff;text-decoration:underline}

    /* HEADER */
    header{
      position:sticky;top:0;z-index:50;
      background:rgba(255,255,255,0.95);
      backdrop-filter:blur(10px);
      border-bottom:1px solid var(--line);
    }
    .headerWrap{
      display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap;
      padding:14px 0;
    }
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:54px;height:54px;border-radius:16px;
      background:linear-gradient(135deg,var(--blue),#60a5fa);
      display:grid;place-items:center;color:#fff;
      font-weight:900;letter-spacing:0.6px;
      box-shadow:0 10px 20px rgba(37,99,235,0.25);
      font-size:14px;
    }
    .brandTitle{margin:0;font-size:18px;font-weight:900}
    .brandSub{margin:2px 0 0;color:var(--muted);font-size:13px}

    .searchBox{
      flex:1;min-width:220px;max-width:520px;
      display:flex;gap:8px;align-items:center;
      background:var(--soft);border:1px solid var(--line);
      border-radius:14px;padding:10px 12px;
    }
    .searchBox input{
      border:none;outline:none;background:transparent;width:100%;font-size:14px;
    }

    .btnRow{display:flex;gap:10px;flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background:#fff;
      padding:10px 12px;border-radius:12px;
      font-weight:900;
      cursor:pointer;
      display:inline-block;
      text-align:center;
      user-select:none;
    }
    .btn.primary{
      background:linear-gradient(135deg,var(--blue),var(--blue2));
      border:none;color:#fff;
    }
    .btn.soft{background:var(--soft)}
    .btn.danger{
      background:linear-gradient(135deg,var(--danger),#fb7185);
      border:none;color:#fff;
    }
    .btn:active{transform:translateY(1px)}

    /* CATEGORY NAV */
    .catNav{
      background:#fff;
      border-top:1px solid var(--line);
      border-bottom:1px solid var(--line);
    }
    .catNav .row{
      display:flex;gap:10px;flex-wrap:wrap;
      padding:10px 0;
    }
    .chip{
      padding:8px 10px;border-radius:999px;
      border:1px solid var(--line);
      background:#fff;color:var(--text);
      font-weight:800;font-size:13px;
      white-space:nowrap;
    }
    .chip:hover{border-color:#cbd5e1}

    /* SECTIONS */
    main{padding:16px 0 24px}
    .card{
      background:var(--surface);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow:var(--shadow);
      padding:16px;
    }

    /* HERO */
    .hero{
      display:grid;grid-template-columns:1.4fr 0.6fr;gap:16px;
      padding:18px 0;
    }
    @media(max-width:900px){.hero{grid-template-columns:1fr}}
    .heroBanner{
      display:grid;grid-template-columns:1fr 1fr;gap:12px;align-items:center;
      background:linear-gradient(135deg,#eff6ff,#ffffff);
      border:1px solid rgba(37,99,235,0.18);
    }
    @media(max-width:720px){.heroBanner{grid-template-columns:1fr}}
    .heroTitle{margin:0;font-size:30px}
    .heroText{color:var(--muted);margin:10px 0 0;line-height:1.6}
    .heroImg{
      width:100%;height:240px;border-radius:14px;
      background:#e2e8f0;
      background-size:cover;background-position:center;
      border:1px solid var(--line);
    }

    /* side category cards */
    .sideGrid{display:grid;gap:12px}
    .sideCat{
      display:grid;grid-template-columns:90px 1fr;gap:12px;align-items:center;
      padding:12px;border-radius:16px;
      border:1px solid var(--line);background:#fff;
      box-shadow:var(--shadow2);
    }
    .thumb{
      width:90px;height:70px;border-radius:14px;background:#e2e8f0;
      background-size:cover;background-position:center;
      border:1px solid var(--line);
    }
    .sideCat h3{margin:0;font-size:15px}
    .sideCat p{margin:6px 0 0;color:var(--muted);font-size:13px}

    .strip{
      display:grid;grid-template-columns:repeat(3,1fr);gap:12px;
      margin-top:12px;
    }
    @media(max-width:900px){.strip{grid-template-columns:1fr}}
    .stripItem{
      border:1px solid var(--line);
      background:var(--soft);
      border-radius:16px;
      padding:12px;
    }
    .stripItem b{display:block;margin-bottom:4px}

    /* FORMS */
    input, textarea, select{
      width:100%;
      padding:12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#fff;
      color:var(--text);
      outline:none;
    }
    input:focus, textarea:focus, select:focus{
      border-color:rgba(37,99,235,0.55);
      box-shadow:0 0 0 4px rgba(37,99,235,0.12);
    }
    label{display:block;margin:10px 0 6px;color:var(--muted);font-size:13px}

    /* GRIDS */
    .grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
    @media (max-width:1000px){.grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:720px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media (max-width:420px){.grid{grid-template-columns:1fr}}

    .product{
      padding:12px;border-radius:16px;
      background:#fff;
      border:1px solid var(--line);
      box-shadow:var(--shadow2);
      display:flex;flex-direction:column;gap:10px;
    }
    .prodImg{
      width:100%;height:140px;border-radius:14px;
      background:#eef2ff;
      border:1px solid var(--line);
      display:grid;place-items:center;
      font-size:42px;
      overflow:hidden;
    }
    .prodImg img{width:100%;height:100%;object-fit:cover;display:block}
    .row{display:flex;align-items:center;justify-content:space-between;gap:10px;flex-wrap:wrap}
    .price{font-weight:1000}

    /* CART */
    .cartLine{
      display:flex;justify-content:space-between;gap:10px;align-items:center;
      padding:10px 0;border-bottom:1px dashed #e5e7eb;
    }
    .qtyBox{
      display:flex;gap:6px;align-items:center;
      border:1px solid var(--line);
      border-radius:12px;padding:6px 8px;
      background:var(--soft);
    }

    /* FOOTER */
    footer{
      margin-top:18px;
      border-top:1px solid var(--line);
      background:#fff;
      padding:18px 0;
      color:var(--muted);
      font-size:13px;
    }
    .footGrid{display:grid;grid-template-columns:2fr 1fr 1fr;gap:16px}
    @media(max-width:900px){.footGrid{grid-template-columns:1fr}}

    /* ADMIN UI */
    .adminGrid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    @media(max-width:900px){.adminGrid{grid-template-columns:1fr}}
    .adminItem{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      background:#fff;
      box-shadow:var(--shadow2);
    }
    .adminThumb{
      width:100%;
      height:120px;
      border-radius:12px;
      border:1px solid var(--line);
      background:#eef2ff;
      display:grid;place-items:center;
      overflow:hidden;
    }
    .adminThumb img{width:100%;height:100%;object-fit:cover;display:block}
    .hidden{display:none !important;}
  </style>
</head>

<body>

<!-- TOP BAR -->
<div class="topbar">
  <div class="container wrap">
    <div>
      Delivery: <b>Dumka + 10 km</b> ‚Ä¢ Timing: <b>24√ó7</b> ‚Ä¢ UPI: <b>brave2arjun2812@oksbi</b>
    </div>
    <div>
      Call: <a href="tel:+916205875215">6205875215</a> ‚Ä¢
      <a href="tel:+919955498516">9955498516</a> ‚Ä¢
      WhatsApp: <a href="https://wa.me/916205875215" target="_blank" rel="noopener">6205875215</a>
    </div>
  </div>
</div>

<header>
  <div class="container headerWrap">
    <div class="brand">
      <div class="logo">DEVI</div>
      <div>
        <p class="brandTitle">Umesh Kirana Store</p>
        <p class="brandSub">Rasikpur, Dumka ‚Ä¢ 24√ó7 ‚Ä¢ Delivery within 10 km</p>
      </div>
    </div>

    <div class="searchBox">
      üîé <input id="searchTop" placeholder="Search products (rice, oil, biscuit)..." />
    </div>

    <div class="btnRow">
      <a class="btn soft" href="#cart">Cart</a>
      <a class="btn primary" href="#checkout">Checkout</a>
    </div>
  </div>

  <!-- CATEGORY NAV -->
  <div class="catNav">
    <div class="container row">
      <a class="chip" href="#shop" onclick="setCategory('all')">All</a>
      <a class="chip" href="#shop" onclick="setCategory('Staples')">Staples</a>
      <a class="chip" href="#shop" onclick="setCategory('Spices')">Spices</a>
      <a class="chip" href="#shop" onclick="setCategory('Snacks')">Snacks</a>
      <a class="chip" href="#shop" onclick="setCategory('Household')">Household</a>
      <a class="chip" href="#contact">Contact</a>
      <a class="chip" href="#admin">Admin</a>
    </div>
  </div>
</header>

<main class="container">

  <!-- HERO -->
  <section class="hero">
    <div class="card heroBanner">
      <div>
        <h1 class="heroTitle">Online Grocery ‚Ä¢ Doorstep Delivery</h1>
        <p class="heroText">
          Order daily essentials from <b>Umesh Kirana Store, Dumka</b>.
          We deliver in Dumka and nearby areas within <b>10 km</b>.
          Payment: <b>COD / UPI</b>.
        </p>

        <div class="btnRow" style="margin-top:12px">
          <a class="btn primary" href="#shop">Shop Now</a>
          <a class="btn" href="https://wa.me/916205875215?text=Hello%20Umesh%20Kirana%20Store%2C%20I%20want%20to%20order%20groceries."
             target="_blank" rel="noopener">WhatsApp Order</a>
          <a class="btn danger" href="tel:+916205875215">Emergency Call</a>
        </div>

        <div class="small" style="margin-top:10px">
          UPI ID: <b>brave2arjun2812@oksbi</b>
        </div>
      </div>

      <div class="heroImg" style="background-image:url('https://images.unsplash.com/photo-1542838132-92c53300491e?auto=format&fit=crop&w=1100&q=60');"></div>
    </div>

    <div class="card">
      <h3 style="margin:0 0 10px">Quick Categories</h3>

      <div class="sideGrid">
        <div class="sideCat" onclick="setCategory('Staples'); location.hash='#shop';" style="cursor:pointer">
          <div class="thumb" style="background-image:url('https://images.unsplash.com/photo-1586201375761-83865001e17b?auto=format&fit=crop&w=600&q=60');"></div>
          <div>
            <h3>Staples</h3>
            <p>Rice ‚Ä¢ Atta ‚Ä¢ Sugar ‚Ä¢ Tea</p>
          </div>
        </div>

        <div class="sideCat" onclick="setCategory('Spices'); location.hash='#shop';" style="cursor:pointer">
          <div class="thumb" style="background-image:url('https://images.unsplash.com/photo-1615485737651-2b9c9b4dfb8c?auto=format&fit=crop&w=600&q=60');"></div>
          <div>
            <h3>Spices</h3>
            <p>Haldi ‚Ä¢ Mirch ‚Ä¢ Jeera</p>
          </div>
        </div>

        <div class="sideCat" onclick="setCategory('Snacks'); location.hash='#shop';" style="cursor:pointer">
          <div class="thumb" style="background-image:url('https://images.unsplash.com/photo-1514995669114-6081e934b693?auto=format&fit=crop&w=600&q=60');"></div>
          <div>
            <h3>Snacks</h3>
            <p>Biscuits ‚Ä¢ Chips ‚Ä¢ Cold Drinks</p>
          </div>
        </div>
      </div>

      <div class="strip">
        <div class="stripItem">
          <b>Delivery</b>
          <div class="small">Free above ‚Çπ499</div>
        </div>
        <div class="stripItem">
          <b>Call</b>
          <div class="small">6205875215</div>
        </div>
        <div class="stripItem">
          <b>UPI</b>
          <div class="small">brave2arjun2812@oksbi</div>
        </div>
      </div>
    </div>
  </section>

  <!-- SHOP -->
  <section id="shop" class="card">
    <div class="row">
      <h3 style="margin:0;font-size:20px">Featured Products</h3>
      <div class="small">Add items to cart and checkout via WhatsApp.</div>
    </div>

    <div class="row" style="gap:10px;margin:12px 0">
      <input id="search" placeholder="Search products (rice, oil, biscuit)..." oninput="renderProducts()"/>
      <select id="category" onchange="renderProducts()" style="max-width:260px">
        <option value="all">All Categories</option>
        <option value="Staples">Staples</option>
        <option value="Spices">Spices</option>
        <option value="Snacks">Snacks</option>
        <option value="Household">Household</option>
      </select>
    </div>

    <div id="productGrid" class="grid"></div>
  </section>

  <!-- CART -->
  <section id="cart" class="card" style="margin-top:14px">
    <div class="row">
      <h3 style="margin:0;font-size:20px">Your Cart</h3>
      <button class="btn" onclick="clearCart()">Clear Cart</button>
    </div>

    <div id="cartItems" style="margin-top:8px"></div>

    <div class="row" style="margin-top:12px">
      <div class="small">Subtotal</div>
      <div class="price" id="subtotal">‚Çπ0</div>
    </div>
    <div class="row" style="margin-top:6px">
      <div class="small">Estimated Delivery</div>
      <div class="price" id="deliveryFee">‚Çπ0</div>
    </div>
    <div class="row" style="margin-top:6px;border-top:1px solid var(--line);padding-top:10px">
      <div class="small" style="font-weight:1000">Total</div>
      <div class="price" id="total">‚Çπ0</div>
    </div>

    <div class="btnRow" style="margin-top:12px">
      <a class="btn primary" href="#checkout">Proceed to Checkout</a>
    </div>
  </section>

  <!-- CHECKOUT -->
  <section id="checkout" class="card" style="margin-top:14px">
    <h3 style="margin:0 0 6px;font-size:20px">Checkout</h3>
    <p class="small" style="margin:0">
      Fill details and place order on WhatsApp. Delivery within <b>10 km</b> of Dumka.
    </p>

    <div class="grid" style="grid-template-columns:repeat(2,1fr);margin-top:10px">
      <div>
        <label>Name</label>
        <input id="custName" placeholder="Your name"/>
      </div>
      <div>
        <label>Mobile Number</label>
        <input id="custPhone" placeholder="10-digit number"/>
      </div>
    </div>

    <label>Delivery Address (Dumka + 10 km)</label>
    <textarea id="custAddress" rows="3" placeholder="House/Street, Landmark, Area, PIN"></textarea>

    <div class="grid" style="grid-template-columns:repeat(2,1fr);margin-top:10px">
      <div>
        <label>Payment Method</label>
        <select id="paymentMethod">
          <option value="COD">Cash on Delivery (COD)</option>
          <option value="UPI">UPI (Pay to UPI ID)</option>
        </select>
      </div>
      <div>
        <label>Emergency Contact</label>
        <a class="btn danger" style="width:100%" href="tel:+916205875215">Call Now (6205875215)</a>
      </div>
    </div>

    <div class="card" style="margin-top:12px;background:linear-gradient(135deg,#eff6ff,#ffffff);border:1px solid rgba(37,99,235,0.18)">
      <div style="font-weight:1000;margin-bottom:6px">UPI Payment (Optional)</div>
      <div class="small">Pay to UPI ID: <b>brave2arjun2812@oksbi</b></div>
      <div class="btnRow" style="margin-top:10px">
        <a class="btn primary" id="upiPayBtn" href="#" target="_blank" rel="noopener">Pay Now via UPI</a>
      </div>
      <div class="small" style="margin-top:8px">After paying, share screenshot/UTR on WhatsApp while placing order.</div>
    </div>

    <div class="btnRow" style="margin-top:12px">
      <button class="btn primary" onclick="placeOrder()">Place Order (WhatsApp)</button>
      <button class="btn" onclick="copyOrderText()">Copy Order Text</button>
    </div>

    <div class="small" style="margin-top:10px">
      WhatsApp Order Number: <b>6205875215</b>
    </div>
  </section>

  <!-- CONTACT -->
  <section id="contact" class="card" style="margin-top:14px">
    <h3 style="margin:0 0 10px;font-size:20px">Contact</h3>

    <div class="grid" style="grid-template-columns:repeat(3,1fr)">
      <div class="product">
        <div class="prodImg" style="height:110px">üìç</div>
        <h3 style="margin:0">Address</h3>
        <div class="small" style="line-height:1.8">
          Rasikpur, Badhaipara,<br/>
          Near Sharma Ekta Club,<br/>
          Railway Station Road,<br/>
          Dumka, Jharkhand 814101
        </div>
      </div>

      <div class="product">
        <div class="prodImg" style="height:110px">üìû</div>
        <h3 style="margin:0">Phone (24√ó7)</h3>
        <div class="small" style="line-height:1.9">
          <a href="tel:+916205875215"><u>6205875215</u></a><br/>
          <a href="tel:+919955498516"><u>9955498516</u></a>
        </div>
      </div>

      <div class="product">
        <div class="prodImg" style="height:110px">üí¨</div>
        <h3 style="margin:0">WhatsApp</h3>
        <div class="small">
          <a href="https://wa.me/916205875215" target="_blank" rel="noopener"><u>Chat on WhatsApp</u></a>
        </div>
      </div>
    </div>
  </section>

  <!-- ADMIN (same file) -->
  <section id="admin" class="card" style="margin-top:14px">
    <div class="row">
      <div>
        <h3 style="margin:0;font-size:20px">Admin Panel (Add / Edit Products)</h3>
        <div class="small">Products save on this phone/browser. (Same phone me site open karoge to updates dikhenge.)</div>
      </div>
      <div class="btnRow">
        <button class="btn soft" onclick="exportProducts()">Export</button>
        <label class="btn soft" style="display:inline-block">
          Import <input type="file" accept="application/json" onchange="importProducts(event)" style="display:none">
        </label>
        <button class="btn soft" onclick="resetProducts()">Reset Default</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px;background:var(--soft);border:1px solid var(--line);box-shadow:none">
      <b>Image kaise add kare?</b>
      <div class="small" style="margin-top:6px">
        1) Image URL paste karo (best) <br/>
        2) Ya ‚ÄúUpload Photo‚Äù use karo (mobile se) ‚Äî photo save ho jayegi.
      </div>
    </div>

    <div style="margin-top:12px" class="adminGrid">
      <div>
        <label>Product Name</label>
        <input id="ap_name" placeholder="e.g. Rice (1 kg)">
      </div>
      <div>
        <label>Category</label>
        <select id="ap_cat">
          <option>Staples</option>
          <option>Spices</option>
          <option>Snacks</option>
          <option>Household</option>
        </select>
      </div>
      <div>
        <label>Price (‚Çπ)</label>
        <input id="ap_price" type="number" placeholder="e.g. 65">
      </div>
    </div>

    <div style="margin-top:10px" class="adminGrid">
      <div style="grid-column: span 2">
        <label>Image URL (optional)</label>
        <input id="ap_imgurl" placeholder="e.g. https://.../rice.jpg OR assets/rice.jpg">
      </div>
      <div>
        <label>Upload Photo (optional)</label>
        <input id="ap_imgfile" type="file" accept="image/*">
      </div>
    </div>

    <div class="btnRow" style="margin-top:12px">
      <button class="btn soft" onclick="clearAdminForm()">Clear</button>
      <button class="btn primary" onclick="saveAdminProduct()">Save Product</button>
    </div>

    <div class="row" style="margin-top:14px">
      <b>All Products</b>
      <input id="ap_search" placeholder="Search product here..." style="max-width:320px" oninput="renderAdminList()">
    </div>

    <div id="adminList" style="margin-top:12px;display:grid;gap:10px"></div>

    <div class="small" style="margin-top:10px">
      Note: Ye admin ‚Äúsecure login‚Äù nahi hai (GitHub HTML static hai). Agar future me real vendors + secure admin chahiye, to Firebase/Backend add karna hoga.
    </div>
  </section>

</main>

<footer>
  <div class="container footGrid">
    <div>
      <b>Umesh Kirana Store</b><br/>
      Rasikpur, Badhaipara, Near Sharma Ekta Club, Railway Station Road, Dumka, Jharkhand 814101
      <div class="small" style="margin-top:6px">Delivery within 10 km ‚Ä¢ Open 24√ó7</div>
    </div>
    <div>
      <b>Quick Links</b><br/>
      <a href="#shop">Shop</a><br/>
      <a href="#cart">Cart</a><br/>
      <a href="#checkout">Checkout</a><br/>
      <a href="#admin">Admin</a><br/>
      <a href="#contact">Contact</a>
    </div>
    <div>
      <b>Payment</b><br/>
      UPI: brave2arjun2812@oksbi<br/>
      WhatsApp: <a href="https://wa.me/916205875215" target="_blank" rel="noopener">6205875215</a><br/>
      Call: 6205875215 / 9955498516
    </div>
  </div>
  <div class="container" style="margin-top:10px">
    ¬© <span id="year"></span> Umesh Kirana Store, Dumka
  </div>
</footer>

<script>
  // STORE DETAILS (fixed)
  const WHATSAPP_NUMBER = "916205875215";
  const STORE_UPI_ID = "brave2arjun2812@oksbi";
  const STORE_UPI_NAME = "Umesh Kirana Store";

  // DEFAULT PRODUCTS (fallback)
  const defaultProducts = [
    {id:1,  name:"Rice (1 kg)",               category:"Staples",   price:65,  image:""},
    {id:2,  name:"Wheat Flour / Atta (1 kg)", category:"Staples",   price:55,  image:""},
    {id:3,  name:"Toor Dal (1 kg)",           category:"Staples",   price:140, image:""},
    {id:4,  name:"Mustard Oil (1 L)",         category:"Staples",   price:165, image:""},
    {id:5,  name:"Sugar (1 kg)",              category:"Staples",   price:48,  image:""},
    {id:6,  name:"Tea (250 g)",               category:"Staples",   price:125, image:""},
    {id:7,  name:"Turmeric Powder (200 g)",   category:"Spices",    price:45,  image:""},
    {id:8,  name:"Red Chilli Powder (200 g)", category:"Spices",    price:60,  image:""},
    {id:9,  name:"Cumin / Jeera (100 g)",     category:"Spices",    price:55,  image:""},
    {id:10, name:"Biscuits (Pack)",           category:"Snacks",    price:20,  image:""},
    {id:11, name:"Chips (Pack)",              category:"Snacks",    price:20,  image:""},
    {id:12, name:"Detergent (1 kg)",          category:"Household", price:95,  image:""},
  ];

  // PRODUCTS storage key
  const PRODUCTS_KEY = "uk_products_v1";

  function loadProducts(){
    try{
      const saved = JSON.parse(localStorage.getItem(PRODUCTS_KEY) || "null");
      if(Array.isArray(saved) && saved.length) return saved;
    }catch(e){}
    return defaultProducts;
  }
  function saveProducts(){
    localStorage.setItem(PRODUCTS_KEY, JSON.stringify(products));
  }

  // Products used by site:
  let products = loadProducts();

  // CART (saved in browser)
  const cart = JSON.parse(localStorage.getItem("uk_cart") || "{}"); // {id:qty}
  const money = n => "‚Çπ" + Number(n||0).toFixed(0);
  const saveCart = () => localStorage.setItem("uk_cart", JSON.stringify(cart));

  function addToCart(id){
    cart[id] = (cart[id]||0) + 1;
    saveCart(); renderCart();
  }
  function setQty(id, qty){
    if(qty<=0) delete cart[id]; else cart[id]=qty;
    saveCart(); renderCart();
  }
  function clearCart(){
    for(const k in cart) delete cart[k];
    saveCart(); renderCart();
  }

  function getCartLines(){
    const lines=[];
    for(const [id,qty] of Object.entries(cart)){
      const p = products.find(x=>x.id===Number(id));
      if(!p) continue;
      lines.push({...p, qty, lineTotal:p.price*qty});
    }
    return lines;
  }

  function calcTotals(){
    const lines = getCartLines();
    const subtotal = lines.reduce((s,x)=>s+x.lineTotal,0);
    // Delivery rule: Free above ‚Çπ499 else ‚Çπ30
    const delivery = (subtotal>=499 || subtotal===0) ? 0 : 30;
    return {subtotal, delivery, total: subtotal+delivery};
  }

  function productEmoji(cat){
    if(cat==="Staples") return "üåæ";
    if(cat==="Spices") return "üßÇ";
    if(cat==="Snacks") return "üç™";
    if(cat==="Household") return "üßº";
    return "üõí";
  }

  function renderProducts(){
    const q = (document.getElementById("search").value||"").toLowerCase().trim();
    const cat = document.getElementById("category").value;

    const filtered = products.filter(p=>{
      const mq = !q || String(p.name||"").toLowerCase().includes(q);
      const mc = (cat==="all") || p.category===cat;
      return mq && mc;
    });

    document.getElementById("productGrid").innerHTML = filtered.map(p=>{
      const img = p.image ? `<img src="${p.image}" alt="">` : productEmoji(p.category);
      return `
        <div class="product">
          <div class="prodImg">${img}</div>
          <div class="row">
            <h3 style="margin:0;font-size:16px">${escapeHtml(p.name)}</h3>
            <div class="small">${escapeHtml(p.category)}</div>
          </div>
          <div class="row">
            <div class="price">${money(p.price)}</div>
            <button class="btn primary" onclick="addToCart(${p.id})">Add</button>
          </div>
          <div class="small">Delivery: Dumka + 10 km</div>
        </div>
      `;
    }).join("");
  }

  function makeUpiLink(amount){
    const pa = encodeURIComponent(STORE_UPI_ID);
    const pn = encodeURIComponent(STORE_UPI_NAME);
    const am = encodeURIComponent(String(amount||0));
    const tn = encodeURIComponent("Grocery Order - Umesh Kirana Store");
    return `upi://pay?pa=${pa}&pn=${pn}&am=${am}&cu=INR&tn=${tn}`;
  }

  function renderCart(){
    const lines = getCartLines();
    const cartBox = document.getElementById("cartItems");

    if(lines.length===0){
      cartBox.innerHTML = `<p class="small">Your cart is empty. Go to <a href="#shop"><u>Shop</u></a> to add items.</p>`;
    }else{
      cartBox.innerHTML = lines.map(p=>`
        <div class="cartLine">
          <div>
            <div style="font-weight:1000">${escapeHtml(p.name)}</div>
            <div class="small">${money(p.price)} each</div>
          </div>
          <div class="row" style="gap:10px">
            <div class="qtyBox">
              <button class="btn" onclick="setQty(${p.id}, ${p.qty-1})">-</button>
              <div style="min-width:26px;text-align:center;font-weight:1000">${p.qty}</div>
              <button class="btn" onclick="setQty(${p.id}, ${p.qty+1})">+</button>
            </div>
            <div class="price">${money(p.lineTotal)}</div>
          </div>
        </div>
      `).join("");
    }

    const {subtotal, delivery, total} = calcTotals();
    document.getElementById("subtotal").innerText = money(subtotal);
    document.getElementById("deliveryFee").innerText = money(delivery);
    document.getElementById("total").innerText = money(total);
    document.getElementById("upiPayBtn").href = makeUpiLink(total);
  }

  function buildOrderText(){
    const name = document.getElementById("custName").value.trim();
    const phone = document.getElementById("custPhone").value.trim();
    const address = document.getElementById("custAddress").value.trim();
    const payment = document.getElementById("paymentMethod").value;

    const lines = getCartLines();
    const {subtotal, delivery, total} = calcTotals();

    let text = `*New Order - Umesh Kirana Store (Dumka)*%0A`;
    text += `Name: ${encodeURIComponent(name||"-")}%0A`;
    text += `Phone: ${encodeURIComponent(phone||"-")}%0A`;
    text += `Address: ${encodeURIComponent(address||"-")}%0A`;
    text += `Payment: ${encodeURIComponent(payment)}%0A`;
    text += `Delivery Area: Dumka + 10 km%0A%0A`;
    text += `*Items*%0A`;
    lines.forEach(p=>{
      text += `- ${encodeURIComponent(p.name)} x${p.qty} = ${encodeURIComponent(money(p.lineTotal))}%0A`;
    });
    text += `%0ASubtotal: ${encodeURIComponent(money(subtotal))}%0A`;
    text += `Delivery: ${encodeURIComponent(money(delivery))}%0A`;
    text += `*Total: ${encodeURIComponent(money(total))}*%0A`;
    text += `%0AUPI: ${encodeURIComponent(STORE_UPI_ID)}%0A(If paid via UPI, share screenshot/UTR.)`;
    return text;
  }

  function placeOrder(){
    const lines = getCartLines();
    if(lines.length===0){ alert("Your cart is empty. Add items first."); location.hash="#shop"; return; }

    const name = document.getElementById("custName").value.trim();
    const phone = document.getElementById("custPhone").value.trim();
    const address = document.getElementById("custAddress").value.trim();
    if(!name || !phone || !address){ alert("Please fill Name, Phone, and Address."); return; }

    const waUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${buildOrderText()}`;
    window.open(waUrl, "_blank");
  }

  function copyOrderText(){
    const lines = getCartLines();
    if(lines.length===0){ alert("Cart is empty."); return; }

    const {subtotal, delivery, total} = calcTotals();
    const name = document.getElementById("custName").value.trim() || "-";
    const phone = document.getElementById("custPhone").value.trim() || "-";
    const address = document.getElementById("custAddress").value.trim() || "-";
    const payment = document.getElementById("paymentMethod").value;

    let text = `New Order - Umesh Kirana Store (Dumka)\n`;
    text += `Name: ${name}\nPhone: ${phone}\nAddress: ${address}\nPayment: ${payment}\nDelivery Area: Dumka + 10 km\n\nItems:\n`;
    getCartLines().forEach(p=> text += `- ${p.name} x${p.qty} = ${money(p.lineTotal)}\n`);
    text += `\nSubtotal: ${money(subtotal)}\nDelivery: ${money(delivery)}\nTotal: ${money(total)}\nUPI: ${STORE_UPI_ID}\n(If paid via UPI, share screenshot/UTR.)`;

    navigator.clipboard.writeText(text).then(()=>alert("Order text copied!"));
  }

  // CATEGORY helper
  function setCategory(cat){
    const sel = document.getElementById("category");
    if(!sel) return;
    sel.value = cat;
    renderProducts();
  }

  // Sync top search with shop search
  function syncSearchTop(){
    const top = document.getElementById("searchTop");
    const shop = document.getElementById("search");
    if(!top || !shop) return;
    top.addEventListener("input", ()=>{
      shop.value = top.value;
      renderProducts();
    });
  }

  // ------- ADMIN (same file) -------
  let editingId = null;

  function clearAdminForm(){
    editingId = null;
    document.getElementById("ap_name").value = "";
    document.getElementById("ap_cat").value = "Staples";
    document.getElementById("ap_price").value = "";
    document.getElementById("ap_imgurl").value = "";
    document.getElementById("ap_imgfile").value = "";
  }

  function getNextId(){
    return (products.reduce((m,p)=>Math.max(m, Number(p.id)||0), 0) || 0) + 1;
  }

  async function saveAdminProduct(){
    const name = document.getElementById("ap_name").value.trim();
    const category = document.getElementById("ap_cat").value;
    const price = Number(document.getElementById("ap_price").value);
    const imgUrl = document.getElementById("ap_imgurl").value.trim();
    const file = document.getElementById("ap_imgfile").files?.[0];

    if(!name || !price || price<=0){
      alert("Please enter Name and valid Price.");
      return;
    }

    let image = imgUrl || "";
    // If file uploaded, convert to base64 (works on mobile)
    if(file){
      image = await fileToDataURL(file);
    }

    if(editingId){
      const idx = products.findIndex(p=>p.id===editingId);
      if(idx>=0){
        products[idx] = {...products[idx], name, category, price, image};
      }
    }else{
      products.push({id:getNextId(), name, category, price, image});
    }

    saveProducts();
    clearAdminForm();
    renderProducts();
    renderAdminList();
    alert("Saved! Now your shop products updated.");
  }

  function editAdminProduct(id){
    const p = products.find(x=>x.id===id);
    if(!p) return;
    editingId = id;
    document.getElementById("ap_name").value = p.name || "";
    document.getElementById("ap_cat").value = p.category || "Staples";
    document.getElementById("ap_price").value = p.price || "";
    document.getElementById("ap_imgurl").value = (p.image && p.image.startsWith("data:")) ? "" : (p.image || "");
    document.getElementById("ap_imgfile").value = "";
    location.hash = "#admin";
    window.scrollTo({top:0, behavior:"smooth"});
  }

  function deleteAdminProduct(id){
    if(!confirm("Delete this product?")) return;
    products = products.filter(p=>p.id!==id);
    saveProducts();
    renderProducts();
    renderAdminList();
  }

  function resetProducts(){
    if(!confirm("Reset all products to default?")) return;
    products = [...defaultProducts];
    saveProducts();
    renderProducts();
    renderAdminList();
    alert("Reset done.");
  }

  function renderAdminList(){
    const q = (document.getElementById("ap_search").value||"").toLowerCase().trim();
    const show = products.filter(p=>!q || String(p.name||"").toLowerCase().includes(q));

    document.getElementById("adminList").innerHTML = show.map(p=>{
      const img = p.image
        ? `<div class="adminThumb"><img src="${p.image}" alt=""></div>`
        : `<div class="adminThumb"><span class="small">No image</span></div>`;
      return `
        <div class="adminItem">
          <div class="row">
            <div style="flex:1">
              <b>${escapeHtml(p.name)}</b>
              <div class="small">${escapeHtml(p.category)} ‚Ä¢ ‚Çπ${Number(p.price||0)}</div>
            </div>
            <div class="btnRow">
              <button class="btn soft" onclick="editAdminProduct(${p.id})">Edit</button>
              <button class="btn" onclick="deleteAdminProduct(${p.id})">Delete</button>
            </div>
          </div>
          <div style="margin-top:10px">${img}</div>
          <div class="small" style="margin-top:8px">ID: ${p.id}</div>
        </div>
      `;
    }).join("");
  }

  function exportProducts(){
    const blob = new Blob([JSON.stringify(products,null,2)], {type:"application/json"});
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "products.json";
    a.click();
    URL.revokeObjectURL(url);
  }

  async function importProducts(event){
    const file = event.target.files?.[0];
    if(!file) return;
    const text = await file.text();
    try{
      const data = JSON.parse(text);
      if(!Array.isArray(data)) throw new Error("not array");
      const cleaned = data.map((p,i)=>({
        id: Number(p.id) || (i+1),
        name: String(p.name||"").trim(),
        category: String(p.category||"Staples"),
        price: Number(p.price)||0,
        image: String(p.image||"")
      })).filter(p=>p.name && p.price>0);

      products = cleaned.length ? cleaned : [...defaultProducts];
      saveProducts();
      renderProducts();
      renderAdminList();
      alert("Imported successfully!");
    }catch(e){
      alert("Invalid JSON file.");
    }
  }

  function fileToDataURL(file){
    return new Promise((resolve,reject)=>{
      const reader = new FileReader();
      reader.onload = ()=> resolve(String(reader.result));
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  function escapeHtml(str){
    return String(str||"")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  // INIT
  document.getElementById("year").innerText = new Date().getFullYear();
  syncSearchTop();
  renderProducts();
  renderCart();
  renderAdminList();
</script>

</body>
</html>
